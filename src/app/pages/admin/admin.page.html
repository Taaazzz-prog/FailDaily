<ion-header>
    <ion-toolbar>
        <ion-title>üõ†Ô∏è Panneau d'Administration</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="refresh()">
                <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content>
    <!-- Refresher -->
    <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Segments pour navigation -->
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChanged($event)">
        <ion-segment-button value="dashboard">
            <ion-icon name="stats-chart-outline"></ion-icon>
            <ion-label>Dashboard</ion-label>
        </ion-segment-button>
        <ion-segment-button value="config">
            <ion-icon name="settings-outline"></ion-icon>
            <ion-label>Config</ion-label>
        </ion-segment-button>
        <ion-segment-button value="users">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>Utilisateurs</ion-label>
        </ion-segment-button>
        <ion-segment-button value="logs">
            <ion-icon name="bug-outline"></ion-icon>
            <ion-label>Logs</ion-label>
        </ion-segment-button>
        <ion-segment-button value="realtime">
            <ion-icon name="eye-outline"></ion-icon>
            <ion-label>Temps R√©el</ion-label>
        </ion-segment-button>
    </ion-segment>

    <!-- DASHBOARD SECTION -->
    <div *ngIf="selectedSegment === 'dashboard'">
        <ion-card>
            <ion-card-header>
                <ion-card-title>
                    üìä Statistiques G√©n√©rales
                    <ion-spinner *ngIf="loading" name="dots"></ion-spinner>
                </ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-grid>
                    <ion-row>
                        <ion-col size="6">
                            <div class="stat-card">
                                <h3>{{ dashboardStats.totalUsers }}</h3>
                                <p>Utilisateurs Totaux</p>
                            </div>
                        </ion-col>
                        <ion-col size="6">
                            <div class="stat-card">
                                <h3>{{ dashboardStats.totalFails }}</h3>
                                <p>Fails Totaux</p>
                            </div>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <ion-col size="6">
                            <div class="stat-card">
                                <h3>{{ dashboardStats.totalReactions }}</h3>
                                <p>R√©actions Totales</p>
                            </div>
                        </ion-col>
                        <ion-col size="6">
                            <div class="stat-card">
                                <h3>{{ dashboardStats.todayActivity }}</h3>
                                <p>Activit√© Aujourd'hui</p>
                            </div>
                        </ion-col>
                    </ion-row>
                </ion-grid>

                <div class="system-status">
                    <ion-chip [color]="getStatusColor(dashboardStats.systemStatus)">
                        <ion-icon name="checkmark-circle-outline"
                            *ngIf="dashboardStats.systemStatus === 'healthy'"></ion-icon>
                        <ion-icon name="warning-outline" *ngIf="dashboardStats.systemStatus === 'warning'"></ion-icon>
                        <ion-icon name="close-circle-outline"
                            *ngIf="dashboardStats.systemStatus === 'error'"></ion-icon>
                        <ion-label>Statut: {{ dashboardStats.systemStatus }}</ion-label>
                    </ion-chip>
                </div>

                <ion-button expand="block" (click)="analyzeDatabase()" [disabled]="loading">
                    <ion-icon name="information-circle-outline" slot="start"></ion-icon>
                    Analyser la Base de Donn√©es
                </ion-button>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- CONFIGURATION SECTION -->
    <div *ngIf="selectedSegment === 'config'">
        <ion-card>
            <ion-card-header>
                <ion-card-title>‚öôÔ∏è Configuration des Points</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-item>
                    <ion-label position="stacked">Points pour cr√©er un Fail</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.createFailPoints"></ion-input>
                </ion-item>

                <ion-item>
                    <ion-label position="stacked">Points r√©action Courage</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.courageReactionPoints"></ion-input>
                </ion-item>

                <ion-item>
                    <ion-label position="stacked">Points r√©action Rire</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.laughReactionPoints"></ion-input>
                </ion-item>

                <ion-item>
                    <ion-label position="stacked">Points r√©action Empathie</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.empathyReactionPoints"></ion-input>
                </ion-item>

                <ion-item>
                    <ion-label position="stacked">Points r√©action Soutien</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.supportReactionPoints"></ion-input>
                </ion-item>

                <ion-item>
                    <ion-label position="stacked">Bonus quotidien</ion-label>
                    <ion-input type="number" [(ngModel)]="pointsConfig.dailyBonusPoints"></ion-input>
                </ion-item>

                <div class="button-group">
                    <ion-button expand="block" (click)="savePointsConfiguration()">
                        <ion-icon name="save-outline" slot="start"></ion-icon>
                        Sauvegarder Configuration
                    </ion-button>

                    <ion-button expand="block" fill="outline" (click)="resetPointsConfiguration()">
                        <ion-icon name="refresh-outline" slot="start"></ion-icon>
                        R√©initialiser
                    </ion-button>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- USERS SECTION -->
    <div *ngIf="selectedSegment === 'users'">
        <ion-card>
            <ion-card-header>
                <ion-card-title>üë• Gestion Compl√®te des Utilisateurs</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <!-- Liste des utilisateurs -->
                <h4>üë§ Tous les Utilisateurs</h4>
                <ion-list>
                    <ion-item *ngFor="let user of allUsers">
                        <ion-avatar slot="start">
                            <img [src]="user.avatar_url || '/assets/default-avatar.png'" alt="Avatar">
                        </ion-avatar>
                        <ion-label>
                            <h3>{{ user.display_name || user.username }}</h3>
                            <p>{{ user.email }}</p>
                            <p><small>R√¥le: {{ user.role || 'user' }} | Points: {{ user.points || 0 }}</small></p>
                        </ion-label>

                        <ion-button fill="clear" size="small" (click)="showUserActions(user)" slot="end">
                            <ion-icon name="settings-outline"></ion-icon>
                        </ion-button>
                    </ion-item>
                </ion-list>

                <!-- Section des actions utilisateur -->
                <div *ngIf="selectedUser" class="user-management-section">
                    <ion-card color="light">
                        <ion-card-header>
                            <ion-card-title>‚öôÔ∏è Gestion de {{ selectedUser.display_name || selectedUser.username
                                }}</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Modifier le compte -->
                            <h5>üìù Modifier le Compte</h5>
                            <ion-item>
                                <ion-label position="stacked">Nom d'affichage</ion-label>
                                <ion-input [(ngModel)]="userEditForm.display_name"></ion-input>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">R√¥le</ion-label>
                                <ion-select [(ngModel)]="userEditForm.role">
                                    <ion-select-option value="user">Utilisateur</ion-select-option>
                                    <ion-select-option value="admin">Administrateur</ion-select-option>
                                    <ion-select-option value="moderator">Mod√©rateur</ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Points</ion-label>
                                <ion-input type="number" [(ngModel)]="userEditForm.points"></ion-input>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Raison de la modification</ion-label>
                                <ion-textarea [(ngModel)]="userEditForm.reason"
                                    placeholder="Pourquoi modifier ce compte?"></ion-textarea>
                            </ion-item>

                            <div class="button-group">
                                <ion-button expand="block" color="primary" (click)="updateUserAccount()">
                                    <ion-icon name="save-outline" slot="start"></ion-icon>
                                    Sauvegarder les Modifications
                                </ion-button>
                            </div>

                            <!-- Actions sur les donn√©es utilisateur -->
                            <h5>üóëÔ∏è Actions sur les Donn√©es</h5>
                            <div class="dangerous-actions">
                                <ion-button expand="block" color="warning" fill="outline" (click)="showUserReactions()">
                                    <ion-icon name="heart-outline" slot="start"></ion-icon>
                                    G√©rer les R√©actions ({{ userReactionsCount }})
                                </ion-button>

                                <ion-button expand="block" color="warning" fill="outline" (click)="showUserFails()">
                                    <ion-icon name="warning-outline" slot="start"></ion-icon>
                                    G√©rer les Fails ({{ userFailsCount }})
                                </ion-button>
                            </div>

                            <ion-button expand="block" color="medium" fill="clear" (click)="hideUserActions()">
                                <ion-icon name="close-outline" slot="start"></ion-icon>
                                Fermer
                            </ion-button>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- Modal pour les r√©actions -->
                <div *ngIf="showReactionsModal" class="modal-content">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>‚ù§Ô∏è R√©actions de {{ selectedUser.display_name }}</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <ion-list>
                                <ion-item *ngFor="let reaction of userReactions">
                                    <ion-icon [name]="getReactionIcon(reaction.reaction_type)" slot="start"></ion-icon>
                                    <ion-label>
                                        <h3>{{ reaction.reaction_type }}</h3>
                                        <p>Sur: {{ reaction.fail_title }}</p>
                                        <p><small>{{ formatTimestamp(reaction.created_at) }}</small></p>
                                    </ion-label>
                                    <ion-button color="danger" fill="clear" size="small"
                                        (click)="deleteReactionConfirm(reaction)" slot="end">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </ion-button>
                                </ion-item>
                            </ion-list>
                            <ion-button fill="clear" (click)="showReactionsModal = false">Fermer</ion-button>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- Modal pour les fails -->
                <div *ngIf="showFailsModal" class="modal-content">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>üí£ Fails de {{ selectedUser.display_name }}</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <ion-list>
                                <ion-item *ngFor="let fail of userFails">
                                    <ion-label>
                                        <h3>{{ fail.title }}</h3>
                                        <p>{{ fail.description }}</p>
                                        <p><small>{{ formatTimestamp(fail.created_at) }} - {{ fail.reactions_count }}
                                                r√©actions</small></p>
                                    </ion-label>
                                    <ion-button color="danger" fill="clear" size="small"
                                        (click)="deleteFailConfirm(fail)" slot="end">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </ion-button>
                                </ion-item>
                            </ion-list>
                            <ion-button fill="clear" (click)="showFailsModal = false">Fermer</ion-button>
                        </ion-card-content>
                    </ion-card>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- LOGS SECTION -->
    <div *ngIf="selectedSegment === 'logs'">
        <ion-card>
            <ion-card-header>
                <ion-card-title>
                    üêõ Logs Syst√®me
                    <ion-buttons slot="end">
                        <ion-button (click)="exportLogs()">
                            <ion-icon name="download-outline"></ion-icon>
                        </ion-button>
                    </ion-buttons>
                </ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <!-- Recherche dans les logs -->
                <ion-searchbar placeholder="Rechercher dans les logs..." [(ngModel)]="logSearchTerm"
                    (ionInput)="searchInLogs()">
                </ion-searchbar>

                <!-- Filtres pour les logs -->
                <ion-grid>
                    <ion-row>
                        <ion-col size="6">
                            <ion-select [(ngModel)]="selectedLogType" (ionChange)="loadSpecificLogs()">
                                <ion-select-option value="all">Tous les logs</ion-select-option>
                                <ion-select-option value="connexions">Connexions</ion-select-option>
                                <ion-select-option value="fails">Cr√©ation de comptes</ion-select-option>
                                <ion-select-option value="reactions">R√©actions</ion-select-option>
                                <ion-select-option value="erreurs">Erreurs</ion-select-option>
                                <ion-select-option value="admin">Actions Admin</ion-select-option>
                            </ion-select>
                        </ion-col>
                        <ion-col size="6">
                            <ion-select [(ngModel)]="selectedLogPeriod" (ionChange)="loadSpecificLogs()">
                                <ion-select-option value="1h">Derni√®re heure</ion-select-option>
                                <ion-select-option value="24h">Derni√®res 24h</ion-select-option>
                                <ion-select-option value="7d">7 derniers jours</ion-select-option>
                                <ion-select-option value="30d">30 derniers jours</ion-select-option>
                                <ion-select-option value="all">Tout l'historique</ion-select-option>
                            </ion-select>
                        </ion-col>
                    </ion-row>
                </ion-grid>
                <!-- Logs dynamiques avec recherche -->
                <h4>üìã Logs Filtr√©s ({{ filteredLogs.length }})</h4>
                <ion-list>
                    <ion-item *ngFor="let log of filteredLogs | slice:0:30">
                        <ion-icon
                            [name]="log.level === 'error' ? 'close-circle' : log.level === 'warning' ? 'warning' : 'information-circle'"
                            [color]="log.level === 'error' ? 'danger' : log.level === 'warning' ? 'warning' : 'primary'"
                            slot="start">
                        </ion-icon>
                        <ion-label>
                            <h3>{{ log.message }}</h3>
                            <p><strong>{{ log.category }}</strong> - {{ formatTimestamp(log.timestamp) }}</p>
                            <p *ngIf="log.user_name"><small>Par: {{ log.user_name }} ({{ log.user_email }})</small></p>
                            <p *ngIf="log.details && log.showDetails"><small>{{ log.details | json }}</small></p>
                        </ion-label>
                        <ion-button fill="clear" size="small" slot="end" (click)="log.showDetails = !log.showDetails">
                            <ion-icon [name]="log.showDetails ? 'chevron-up' : 'chevron-down'"></ion-icon>
                        </ion-button>
                        <ion-badge
                            [color]="log.level === 'error' ? 'danger' : log.level === 'warning' ? 'warning' : 'medium'"
                            slot="end">
                            {{ log.level }}
                        </ion-badge>
                    </ion-item>
                </ion-list>

                <div *ngIf="filteredLogs.length === 0" class="no-data">
                    <p>Aucun log trouv√© pour ces crit√®res</p>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- REAL-TIME SECTION -->
    <div *ngIf="selectedSegment === 'realtime'">
        <ion-card>
            <ion-card-header>
                <ion-card-title>
                    ‚ö° Monitoring Temps R√©el
                    <ion-button (click)="loadRealTimeData()" size="small" fill="clear">
                        <ion-icon name="refresh-outline"></ion-icon>
                    </ion-button>
                    <ion-toggle [(ngModel)]="autoRefreshEnabled" (ionChange)="toggleAutoRefresh()">
                        Auto-refresh
                    </ion-toggle>
                </ion-card-title>
                <ion-card-subtitle>
                    Derni√®re mise √† jour: {{ lastRealTimeUpdate | date:'short' }}
                </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <!-- Statistiques temps r√©el -->
                <ion-grid>
                    <ion-row>
                        <ion-col size="4">
                            <div class="realtime-stat">
                                <h3>{{ realTimeStats.activeUsers }}</h3>
                                <p>Utilisateurs en ligne</p>
                            </div>
                        </ion-col>
                        <ion-col size="4">
                            <div class="realtime-stat">
                                <h3>{{ realTimeStats.eventsLastHour }}</h3>
                                <p>√âv√©nements/h</p>
                            </div>
                        </ion-col>
                        <ion-col size="4">
                            <div class="realtime-stat">
                                <h3>{{ realTimeStats.systemLoad }}</h3>
                                <p>Charge syst√®me</p>
                            </div>
                        </ion-col>
                    </ion-row>
                </ion-grid>

                <!-- √âv√©nements en temps r√©el -->
                <h4>ÔøΩ Flux d'√âv√©nements en Direct</h4>
                <div class="realtime-events">
                    <ion-list>
                        <ion-item *ngFor="let event of realTimeEvents | slice:0:15">
                            <ion-icon [name]="getEventIcon(event.category)" [color]="getEventColor(event.level)"
                                slot="start">
                            </ion-icon>
                            <ion-label>
                                <h3>{{ event.message }}</h3>
                                <p><strong>{{ event.category }}</strong> - {{ event.user_name || 'Syst√®me' }}</p>
                                <p><small>{{ formatTimestamp(event.timestamp) }} ({{ getTimeAgo(event.timestamp)
                                        }})</small></p>
                            </ion-label>
                            <ion-chip [color]="event.level === 'error' ? 'danger' : 'primary'" slot="end">
                                {{ event.level }}
                            </ion-chip>
                        </ion-item>
                    </ion-list>
                </div>

                <!-- Alertes syst√®me -->
                <div *ngIf="systemAlerts.length > 0">
                    <h4>ÔøΩ Alertes Syst√®me</h4>
                    <ion-list>
                        <ion-item *ngFor="let alert of systemAlerts" color="danger">
                            <ion-icon name="warning-outline" slot="start" color="danger"></ion-icon>
                            <ion-label>
                                <h3>{{ alert.message }}</h3>
                                <p>{{ alert.details }}</p>
                            </ion-label>
                        </ion-item>
                    </ion-list>
                </div>

                <div *ngIf="realTimeEvents.length === 0" class="no-data">
                    <p>Aucun √©v√©nement en temps r√©el</p>
                    <ion-button (click)="loadRealTimeData()">Actualiser</ion-button>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Floating Action Buttons -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
        <ion-fab-button>
            <ion-icon name="settings-outline"></ion-icon>
        </ion-fab-button>
    </ion-fab>
</ion-content>