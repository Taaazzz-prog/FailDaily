# FailDaily - Guide de D√©veloppement pour ChatGPT Codex

## üéØ Mission et Contexte

**FailDaily** est une application de partage d'√©checs personnels pour encourager la r√©silience et l'entraide communautaire.

### Architecture Technique
- **Frontend**: Angular 20 + Ionic 8 (TypeScript, architecture standalone)
- **Backend**: Node.js + Express + MySQL (authentification JWT)
- **Base de donn√©es**: MySQL avec structure compl√®te de logging et gamification

## üìã Objectifs Principaux

1. **Coh√©rence Frontend ‚Üî Backend**: V√©rifier que chaque action UI invoque le bon endpoint
2. **Contrats de donn√©es**: Les JSON retourn√©s matchent les mod√®les TypeScript
3. **R√®gles m√©tier**: Anonymat et validation d'√¢ge strictement appliqu√©s
4. **S√©curit√©**: Authentification JWT sur toutes les routes sensibles

## üóÑÔ∏è Structure de Base de Donn√©es

### Tables Principales
```sql
-- Utilisateurs et profils
users (id, email, password_hash, role, account_status, registration_step, created_at)
profiles (user_id, username, display_name, avatar_url, bio, registration_completed, legal_consent, age_verification)

-- Contenu principal
fails (id, user_id, title, description, category, image_url, is_public TINYINT(1), reactions JSON, comments_count, created_at)
comments (id, fail_id, user_id, content, is_encouragement TINYINT(1), created_at)
reactions (id, user_id, fail_id, reaction_type, created_at)

-- Gamification et logs
badges, user_badges, badge_definitions
activity_logs, user_activities, system_logs
```

### R√®gles de Visibilit√© (is_public)
- **Base de donn√©es**: `TINYINT(1)` avec valeurs `0` (priv√©) et `1` (public/anonyme)
- **Backend API**: Convertit `0`/`1` vers `boolean` avec `!!fail.is_public`
- **Frontend**: Manipule des `boolean` (`true`/`false`)
- **IMPORTANT**: M√™me les fails `is_public = true` n√©cessitent une authentification

## üîó Contrats de Donn√©es

### Mapping Obligatoire (snake_case ‚Üî camelCase)
```javascript
// Backend doit mapper:
users.display_name ‚Üí displayName
fails.image_url ‚Üí imageUrl
fails.comments_count ‚Üí commentsCount
fails.is_public (0/1) ‚Üí boolean
```

### Structures JSON de R√©f√©rence

**User Response:**
```json
{
  "id": "uuid",
  "email": "string",
  "displayName": "string",
  "avatar": "string",
  "role": "user|admin",
  "totalFails": 0,
  "couragePoints": 0,
  "badges": [],
  "emailConfirmed": boolean,
  "registrationCompleted": boolean
}
```

**Fail Response:**
```json
{
  "id": "uuid",
  "title": "string",
  "description": "string",
  "category": "humour|travail|social|personnel|autre",
  "imageUrl": "string|null",
  "authorId": "uuid",
  "authorName": "string", // Anonymis√© si is_public = false
  "authorAvatar": "string",
  "reactions": {
    "courage": 0,
    "empathy": 0,
    "laugh": 0,
    "support": 0
  },
  "commentsCount": 0,
  "is_public": boolean,
  "createdAt": "ISO string"
}
```

## üõ°Ô∏è R√®gles d'Authentification et d'√Çge

### Authentification
- Toutes les routes `/api/*` (sauf auth publiques) n√©cessitent le middleware `authenticateToken`
- JWT stock√© c√¥t√© frontend, envoy√© dans l'header `Authorization: Bearer <token>`

### Validation d'√Çge (inscription)
```javascript
// R√®gles strictes:
if (age < 13) return res.status(400).json({ code: 'AGE_UNDER_MINIMUM' });
if (age >= 13 && age <= 16 && !parentalConsent) {
  return res.status(400).json({ code: 'PARENTAL_CONSENT_REQUIRED' });
}
// age > 16: OK
```

## üåê Endpoints Principaux

### Authentification
- `POST /api/auth/login` - Connexion utilisateur
- `POST /api/auth/register` - Inscription (avec validation d'√¢ge)
- `GET /api/auth/verify` - V√©rification token JWT
- `POST /api/auth/logout` - D√©connexion

### Fails
- `GET /api/fails` - Tous les fails de l'utilisateur connect√©
- `POST /api/fails` - Cr√©er un nouveau fail
- `GET /api/fails/public` - Fails anonymes (`is_public = true`, **auth requise**)
- `GET /api/fails/:id` - D√©tail d'un fail sp√©cifique

### Reactions et Comments
- `POST /api/reactions` - Ajouter une r√©action
- `DELETE /api/reactions/:id` - Supprimer une r√©action
- `GET /api/comments/:failId` - Commentaires d'un fail
- `POST /api/comments` - Ajouter un commentaire

## üß™ Tests Requis

### Backend (Jest + Supertest)
```javascript
// Tests de validation d'√¢ge
describe('Age Validation', () => {
  test('Age < 13 should return AGE_UNDER_MINIMUM', async () => {
    // Test implementation
  });
  
  test('Age 13-16 without consent should return PARENTAL_CONSENT_REQUIRED', async () => {
    // Test implementation
  });
});

// Tests de visibilit√©
describe('Fail Visibility', () => {
  test('is_public=false should not appear in /api/fails/public', async () => {
    // Test implementation
  });
  
  test('is_public=true should appear anonymized in /api/fails/public', async () => {
    // Test implementation
  });
});
```

## üìÅ Structure des Fichiers

### Backend (`backend-api/`)
```
server.js                 // Point d'entr√©e (export app)
src/config/database.js    // MySQL2/promise, executeQuery
src/controllers/          // Logique m√©tier
src/routes/              // D√©finition endpoints
src/middleware/auth.js   // authenticateToken
tests/                   // Jest tests
```

### Frontend (`frontend/src/app/`)
```
services/                // auth.service, fail.service, mysql.service
models/                  // user.model, fail.model (interfaces TS)
pages/                   // auth/, home/, profile/, post-fail/
components/              // Composants r√©utilisables
guards/                  // Protection des routes
```

## üöÄ Commandes de D√©veloppement

### ‚ö†Ô∏è Probl√®mes Connus en Environnement Cloud

**IMPORTANT**: L'environnement cloud ChatGPT Codex peut rencontrer ces erreurs :

1. **Erreur 403 @fontsource** : Acc√®s interdit aux packages fontsource
2. **ESLint module** : Cannot use import outside module
3. **Jest/ng not found** : Outils CLI manquants
4. **Express not found** : Dependencies non install√©es

### Installation Cloud-Safe
```bash
# ‚ö†Ô∏è √âVITER npm ci (peut √©chouer sur fontsource)
# Utiliser npm install √† la place
npm install

# Alternative si @fontsource bloqu√© :
npm install --omit=optional

# Si toujours bloqu√©, supprimer temporairement :
npm uninstall @fontsource/caveat @fontsource/comfortaa @fontsource/kalam
npm install
```

### Configuration ESLint (Fix Cloud)
```bash
# Renommer eslint.config.js en .mjs
mv backend-api/eslint.config.js backend-api/eslint.config.mjs

# OU ajouter "type": "module" dans backend-api/package.json
```

### Installation Outils Manquants
```bash
# Installer Jest globalement
npm install -g jest

# Installer Angular CLI globalement  
npm install -g @angular/cli

# OU installer localement
npm install --save-dev jest @angular/cli
```

### Tests Avec D√©pendances Manquantes
```bash
# V√©rifier modules install√©s
npm list --depth=0

# Installer d√©pendances manquantes backend
cd backend-api && npm install express mysql2 jsonwebtoken bcryptjs cors helmet

# Installer d√©pendances manquantes frontend
cd frontend && npm install @angular/core @angular/common @ionic/angular
```

### Smoke Test Cloud-Safe
```bash
# Test sans d√©pendances externes
NODE_ENV=test DB_DISABLED=true node -e "
try {
  console.log('Node version:', process.version);
  console.log('Testing basic require...');
  const fs = require('fs');
  console.log('‚úÖ Basic Node.js working');
  console.log('SERVER_BOOT_OK');
} catch(e) {
  console.error('‚ùå Error:', e.message);
}
"
```

### Audit de Coh√©rence (Cloud-Safe)
```bash
# ‚ö†Ô∏è Utiliser ces alternatives si grep/rg non disponible :

# Alternative 1: Node.js pour chercher les patterns
node -e "
const fs = require('fs');
const path = require('path');
function searchInDir(dir, pattern) {
  try {
    const files = fs.readdirSync(dir, {withFileTypes: true});
    files.forEach(file => {
      if (file.isDirectory() && !file.name.startsWith('.')) {
        searchInDir(path.join(dir, file.name), pattern);
      } else if (file.name.endsWith('.ts') || file.name.endsWith('.js')) {
        const content = fs.readFileSync(path.join(dir, file.name), 'utf8');
        if (content.includes(pattern)) {
          console.log(\`Found \${pattern} in \${path.join(dir, file.name)}\`);
        }
      }
    });
  } catch(e) { /* ignore */ }
}
searchInDir('frontend/src/app', '/api/');
"

# Alternative 2: find + xargs (si disponible)
find frontend/src/app -name "*.ts" -o -name "*.js" | xargs grep -l "/api/" 2>/dev/null || echo "grep non disponible"

# V√©rifier les routes backend
find backend-api/src/routes -name "*.js" | xargs grep -l "router\." 2>/dev/null || echo "grep non disponible"
```

## üîß Configuration Cloud Sp√©cifique

### Package.json Fixes
```json
// backend-api/package.json - Ajouter si manquant :
{
  "type": "module",  // Pour ESLint avec import
  "scripts": {
    "lint": "eslint . --config eslint.config.mjs",
    "test": "jest --runInBand",
    "start": "node server.js"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "eslint": "^9.0.0"
  }
}
```

### Alternative Sans Fontsource
```css
/* frontend/src/global.scss - Fallback fonts si @fontsource indisponible */
@import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Comfortaa:wght@300;400;700&family=Kalam:wght@300;400;700&display=swap');

/* OU utiliser fonts syst√®me */
:root {
  --font-cursive: 'Caveat', 'Comic Sans MS', cursive;
  --font-rounded: 'Comfortaa', 'Arial Rounded MT', sans-serif;  
  --font-handwritten: 'Kalam', 'Brush Script MT', cursive;
}
```

## ‚ö†Ô∏è Points d'Attention

### Erreurs Communes en Cloud
1. **@fontsource 403** : Packages bloqu√©s ‚Üí utiliser Google Fonts CDN ou fonts syst√®me
2. **ESLint import error** : Ajouter `"type": "module"` ou renommer en `.mjs`
3. **Jest/ng not found** : Installer globalement ou ajouter aux devDependencies
4. **Express not found** : `npm install` peut avoir √©chou√© ‚Üí r√©installer manuellement
5. **npm ci 403** : Utiliser `npm install` √† la place

### Solutions Cloud-Ready
```bash
# Fix rapide pour erreurs communes :

# 1. R√©installation propre
rm -rf node_modules package-lock.json
npm install

# 2. ESLint fix
echo '{"type": "module"}' > backend-api/.eslintrc.json

# 3. Dependencies manquantes
npm install express mysql2 jsonwebtoken bcryptjs cors helmet
npm install @angular/core @angular/common @ionic/angular

# 4. Test sans outils externes
node -e "console.log('Node OK:', process.version)"
```

### Format d'Erreur Standard (Cloud-Safe)
```json
{
  "error": "Message lisible",
  "code": "CODE_CONSTANT", 
  "details": "Informations additionnelles",
  "cloudSafe": true
}
```

**Codes d'erreur principaux:**
- `AGE_UNDER_MINIMUM`
- `PARENTAL_CONSENT_REQUIRED`
- `UNAUTHORIZED`
- `NOT_FOUND`
- `VALIDATION_ERROR`

## ‚úÖ Checklist de Validation (Cloud-Optimis√©e)

Avant de valider une modification en environnement cloud :

### Phase 1: V√©rification Environnement
- [ ] `node --version` fonctionne
- [ ] `npm --version` fonctionne  
- [ ] Dossiers `frontend/` et `backend-api/` existent
- [ ] `package.json` pr√©sent dans les deux dossiers

### Phase 2: Installation S√©curis√©e
- [ ] `npm install` (pas `npm ci`) r√©ussit sans 403
- [ ] Packages essentiels install√©s : `npm list express mysql2`
- [ ] Si @fontsource √©choue, utiliser alternative CDN/syst√®me

### Phase 3: Configuration ESLint
- [ ] ESLint config compatible : `.mjs` ou `"type": "module"`
- [ ] `npm run lint` ou `npx eslint .` fonctionne
- [ ] Pas d'erreur "Cannot use import outside module"

### Phase 4: Tests Minimaux
- [ ] Backend boot : `node -e "require('./backend-api/server')"`
- [ ] Frontend check : `ls frontend/src/app/` montre services/
- [ ] Tests unitaires : `npx jest --version` puis `npx jest`

### Phase 5: Coh√©rence M√©tier  
- [ ] Endpoints frontend correspondent aux routes backend
- [ ] Sch√©mas JSON matchent les mod√®les TypeScript
- [ ] `is_public` g√®re correctement l'anonymat (0/1 ‚Üî boolean)
- [ ] Routes sensibles prot√©g√©es par `authenticateToken`

### Phase 6: Smoke Test Final
```bash
# Test cloud-safe sans d√©pendances externes
NODE_ENV=test DB_DISABLED=true node -e "
console.log('‚úÖ Node.js:', process.version);
console.log('‚úÖ Platform:', process.platform);
console.log('‚úÖ Architecture:', process.arch);
console.log('‚úÖ Memory:', Math.round(process.memoryUsage().rss/1024/1024) + 'MB');
console.log('‚úÖ SERVER_BOOT_OK');
"
```

## üîß Variables d'Environnement

### Backend (.env)
```
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=faildaily
JWT_SECRET=your_jwt_secret
CORS_ORIGIN=http://localhost:4200
```

### Frontend (environment.ts)
```typescript
export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000'
};
```

---

## üî• Guide de D√©pannage Cloud

### Erreur 403 @fontsource
```bash
# Solution 1: Supprimer temporairement
npm uninstall @fontsource/caveat @fontsource/comfortaa @fontsource/kalam
npm install

# Solution 2: Alternative CDN dans global.scss
# @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap');
```

### Erreur ESLint Import
```bash
# Solution 1: Renommer config
mv backend-api/eslint.config.js backend-api/eslint.config.mjs

# Solution 2: Ajouter type module
echo '{"type": "module"}' > backend-api/eslint.package.json
```

### Erreur Jest/ng Not Found
```bash
# Solution: Installation locale
npm install --save-dev jest @angular/cli
npx jest --version
npx ng version
```

### Erreur Express Not Found
```bash
# Solution: R√©installation dependencies
cd backend-api
npm install express mysql2 jsonwebtoken bcryptjs cors helmet dotenv
```

**Note**: Ce guide est optimis√© pour l'environnement cloud ChatGPT Codex avec solutions de contournement pour les limitations d'acc√®s r√©seau et packages.