# üìñ Guide Technique Complet - FailDaily

## üèóÔ∏è **Architecture Globale**

### üéØ **Vue d'Ensemble**
FailDaily est une application de partage d'√©checs constructifs bas√©e sur une architecture moderne monorepo avec Angular 20, Node.js 22, et MySQL 9.

```
üì± Frontend (Angular 20 + Ionic 8)
    ‚ÜïÔ∏è API REST
üöÄ Backend (Node.js 22 + Express)
    ‚ÜïÔ∏è SQL Queries  
üóÑÔ∏è Base de Donn√©es (MySQL 9.1)
    ‚ÜïÔ∏è Triggers & Procedures
üèÜ Syst√®me de Badges Automatis√©
```

---

## üõ†Ô∏è **Stack Technique D√©taill√©e**

### üì± **Frontend - Angular 20 + Ionic 8**
```typescript
// Technologies Principales
- Angular 20 (standalone components)
- Ionic 8 + Capacitor 7 (iOS/Android)
- TypeScript 5.0+, SCSS
- RxJS 7.8.0, Zone.js 0.15

// Librairies Cl√©s
- @angular/* (core, forms, router, common)
- @ionic/angular (components UI)
- @capacitor/* (camera, notifications, filesystem)
- Fontsource (Caveat, Comfortaa, Kalam, Inter)
- Ionicons, Lodash, Moment.js

// Tests & Qualit√©
- Jasmine, Karma
- ESLint 9 + @angular-eslint 20
```

### üöÄ **Backend - Node.js 22 + Express**
```javascript
// Framework & Core
- Node.js 22.x + Express 4.21
- Architecture MVC RESTful
- Middleware: Helmet, CORS, Morgan

// Base de Donn√©es
- MySQL 9.1.0 (utf8mb4)
- mysql2 (connection pool)
- Migrations automatis√©es

// S√©curit√© & Auth
- jsonwebtoken (JWT)
- bcryptjs (hash passwords)  
- express-rate-limit (protection DDoS)
- helmet (headers s√©curit√©)

// Fonctionnalit√©s
- multer (upload images/avatars)
- uuid (g√©n√©ration IDs)
- dotenv (configuration)
- nodemailer (emails)

// Tests & Qualit√©
- Jest + Supertest
- ESLint configuration moderne
```

### üóÑÔ∏è **Base de Donn√©es - MySQL 9.1**
```sql
-- Architecture Relationnelle
CREATE DATABASE faildaily CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Tables Principales (8)
users              -- Utilisateurs et profils
fails              -- Publications d'√©checs  
comments           -- Commentaires sur fails
reactions          -- R√©actions (courage, empathie, etc.)
badges             -- Badges attribu√©s aux utilisateurs
badge_definitions  -- D√©finitions des badges  
notifications      -- Syst√®me de notifications
user_stats         -- Statistiques utilisateurs

-- Triggers Automatis√©s
- Attribution automatique badges
- Mise √† jour statistiques
- Calcul niveaux utilisateur
- Nettoyage donn√©es obsol√®tes
```

---

## üîß **Configuration et Environnements**

### üåç **Environnements Support√©s**

#### üè† **D√©veloppement Local**
```bash
# URLs
Frontend: http://localhost:8100 (Ionic serve)
Backend:  http://localhost:3000 (Node.js)
MySQL:    localhost:3307 (Docker) ou 3306 (local)

# Configuration
NODE_ENV=development
DB_HOST=localhost
JWT_SECRET=dev_secret_key
UPLOAD_PATH=./uploads
```

#### üê≥ **Docker Local**
```bash
# URLs  
Frontend: http://localhost:8080
Backend:  http://localhost:3000
MySQL:    localhost:3306 (container)

# Services
- faildaily_frontend (Nginx + Angular build)
- faildaily_backend (Node.js API)
- faildaily_db (MySQL 9.1)
```

#### üåê **Production OVH**
```bash
# URLs
Site:     https://faildaily.com
API:      https://api.faildaily.com  
PowerPoint: https://faildaily.com/powerpoint

# Infrastructure
- Traefik (reverse proxy + SSL automatique)
- Docker Compose
- Let's Encrypt (certificats SSL)
- MySQL persistant avec volumes
```

---

## üì° **API REST - Endpoints Principaux**

### üîê **Authentification**
```javascript
// Inscription & Connexion  
POST /api/auth/register        // Cr√©er compte
POST /api/auth/login          // Se connecter
GET  /api/auth/verify         // V√©rifier token JWT
POST /api/auth/logout         // Se d√©connecter

// Gestion Profil
GET  /api/auth/profile        // Profil utilisateur
PUT  /api/auth/profile        // Modifier profil  
PUT  /api/auth/password       // Changer mot de passe
POST /api/auth/password-reset // Reset mot de passe
```

### üìù **Gestion des Fails**
```javascript
// CRUD Fails
GET    /api/fails             // Liste fails publics
POST   /api/fails             // Cr√©er nouveau fail
GET    /api/fails/:id         // D√©tails d'un fail
PUT    /api/fails/:id         // Modifier fail (owner)
DELETE /api/fails/:id         // Supprimer fail (owner/admin)

// Interactions
POST   /api/fails/:id/reactions    // Ajouter r√©action
DELETE /api/fails/:id/reactions    // Supprimer r√©action
GET    /api/fails/:id/comments     // Commentaires
POST   /api/fails/:id/comments     // Ajouter commentaire
```

### üèÜ **Syst√®me de Badges**
```javascript
// Badges Utilisateur
GET /api/badges                    // Badges disponibles
GET /api/badges/user/:userId       // Badges d'un utilisateur
GET /api/badges/definitions        // D√©finitions badges

// Attribution Automatique (triggers MySQL)
- Badges courage (nb fails partag√©s)
- Badges empathie (nb r√©actions donn√©es)  
- Badges communaut√© (nb commentaires)
- Badges progression (connexions quotidiennes)
```

---

## üèÜ **Syst√®me de Badges Avanc√©**

### üìä **Cat√©gories et Progression**
```javascript
// 6 Cat√©gories Principales
üéØ COURAGE      - Partage de fails (19 badges)
üíù EMPATHIE     - R√©actions donn√©es (16 badges)  
üí¨ COMMUNAUT√â   - Commentaires et interactions (16 badges)
üåü PROGRESSION  - Activit√© et r√©gularit√© (14 badges)
üèÜ R√âUSSITES    - Objectifs atteints (rare)
üéÅ √âV√âNEMENTS   - Badges saisonniers/sp√©ciaux

// Niveaux de Raret√©
Common (bronze)    - 19 badges
Rare (argent)      - 16 badges
Epic (or)          - 16 badges  
Legendary (platine) - 14 badges
```

### üîÑ **Attribution Automatique**
```sql
-- Triggers MySQL pour attribution temps r√©el
DELIMITER //
CREATE TRIGGER update_badges_after_fail_insert
AFTER INSERT ON fails
FOR EACH ROW
BEGIN
    -- Attribution badges courage
    CALL assign_courage_badges(NEW.user_id);
    -- Mise √† jour statistiques
    CALL update_user_stats(NEW.user_id);
END //
DELIMITER ;
```

---

## üîí **S√©curit√© et Protection**

### üõ°Ô∏è **Mesures de S√©curit√© Impl√©ment√©es**
```javascript
// Protection DDoS et Rate Limiting
app.use(rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100,                 // 100 requ√™tes max
  message: 'Trop de requ√™tes, r√©essayez plus tard'
}));

// Headers de S√©curit√© (Helmet)
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
}));

// Authentification JWT
const authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  if (!token) return res.status(401).json({error: 'Token manquant'});
  
  jwt.verify(token, process.env.JWT_SECRET, (err, decoded) => {
    if (err) return res.status(401).json({error: 'Token invalide'});
    req.user = decoded;
    next();
  });
};
```

### üîê **Protection des Donn√©es**
```javascript
// Hashage Passwords (bcrypt)
const hashPassword = async (password) => {
  return await bcrypt.hash(password, 12);
};

// Validation Inputs (express-validator)
const validateRegistration = [
  body('email').isEmail().normalizeEmail(),
  body('password').isLength({min: 8}).matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/),
  body('displayName').isLength({min: 2, max: 30}).trim().escape()
];

// Upload S√©curis√© (multer)
const upload = multer({
  dest: 'uploads/',
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB max
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('Seules les images sont autoris√©es'));
    }
  }
});
```

---

## üß™ **Tests et Qualit√©**

### üìã **Architecture des Tests**
```bash
backend-api/tests/
‚îú‚îÄ‚îÄ run-all-tests.js           # üéØ Lanceur principal
‚îú‚îÄ‚îÄ 0_test-config.js           # Configuration globale
‚îú‚îÄ‚îÄ 1_database/                # Tests base de donn√©es
‚îÇ   ‚îú‚îÄ‚îÄ 1.1_connection-test.js
‚îÇ   ‚îî‚îÄ‚îÄ 1.2_structure-test.js  
‚îú‚îÄ‚îÄ 2_auth/                    # Tests authentification
‚îÇ   ‚îú‚îÄ‚îÄ 2.1_registration-test-simple.js
‚îÇ   ‚îú‚îÄ‚îÄ 2.2_login-test.js
‚îÇ   ‚îî‚îÄ‚îÄ 2.3_jwt-verification-test.js
‚îú‚îÄ‚îÄ 3_fails/                   # Tests API fails
‚îÇ   ‚îú‚îÄ‚îÄ 3.1_fail-creation-test.js
‚îÇ   ‚îú‚îÄ‚îÄ 3.2_fail-retrieval-test.js
‚îÇ   ‚îî‚îÄ‚îÄ 3.3_comments-basic-test.js
‚îî‚îÄ‚îÄ 4_integration/             # Tests int√©gration
    ‚îî‚îÄ‚îÄ 4.1_complete-integration-test.js
```

### üéØ **Types de Tests**
```javascript
// Tests Unitaires (Jest)
describe('UserService', () => {
  test('should create user with valid data', async () => {
    const userData = { email: 'test@test.com', password: 'password123' };
    const user = await UserService.create(userData);
    expect(user).toHaveProperty('id');
    expect(user.email).toBe(userData.email);
  });
});

// Tests d'Int√©gration (Supertest)
describe('POST /api/auth/register', () => {
  test('should register new user', async () => {
    const response = await request(app)
      .post('/api/auth/register')
      .send({ email: 'new@test.com', password: 'Password123!' })
      .expect(201);
    
    expect(response.body).toHaveProperty('user');
    expect(response.body).toHaveProperty('token');
  });
});

// Tests E2E (Communication Frontend ‚Üî Backend)
// node test-frontend-backend-communication.js
```

---

## üöÄ **D√©ploiement et DevOps**

### üê≥ **Docker Multi-Stage**
```dockerfile
# Frontend Dockerfile
FROM node:22-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80

# Backend Dockerfile  
FROM node:22-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### üìã **Scripts de D√©ploiement**
```bash
# D√©veloppement Local
.\docker\start-local.ps1           # Lancement complet
.\docker\status.ps1                # Monitoring
.\docker\sync-from-ovh.ps1         # Sync donn√©es OVH

# Production OVH
./docker/production/install.sh     # Installation serveur
./docker/production/deploy.sh      # D√©ploiement standard  
./docker/production/deploy-traefik.sh  # D√©ploiement SSL

# Tests et Validation
node backend-api/tests/run-all-tests.js        # Tests backend
node test-frontend-backend-communication.js     # Tests int√©gration
```

---

## üìä **Monitoring et Logs**

### üìà **M√©triques Applicatives**
```javascript
// Health Check Endpoint
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV,
    version: require('./package.json').version,
    database: 'connected', // v√©rification DB
    memory: process.memoryUsage(),
    uptime: process.uptime()
  });
});

// Logs Structur√©s (Morgan + Winston)
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/app.log' })
  ]
});
```

---

## üéØ **Bonnes Pratiques et Conventions**

### üìù **Code Style**
- **TypeScript strict** : types obligatoires
- **ESLint** : configuration moderne
- **Prettier** : formatage automatique
- **Conventional Commits** : messages standardis√©s

### üèóÔ∏è **Architecture**
- **Separation of Concerns** : services, controllers, models s√©par√©s
- **Dependency Injection** : Angular moderne avec `inject()`
- **Error Handling** : gestion d'erreurs centralis√©e
- **Configuration** : variables d'environnement

### üîÑ **Workflows**
- **Feature branches** : d√©veloppement par feature
- **Pull Requests** : review obligatoire
- **Tests automatis√©s** : CI/CD avec GitHub Actions
- **D√©ploiement** : staging ‚Üí production

---

*Guide technique mis √† jour - Septembre 2025*
*Pour une application FailDaily moderne et s√©curis√©e*
