<ion-header [translucent]="true">
    <ion-toolbar>
        <ion-title class="handwriting">Ma Collection de Badges</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
    <!-- Rafra√Æchissement -->
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content pullingIcon="chevron-down-circle-outline" pullingText="Tirer pour rafra√Æchir"
            refreshingSpinner="circles" refreshingText="Actualisation...">
        </ion-refresher-content>
    </ion-refresher>

    <div class="badges-container">
        <!-- En-t√™te d'encouragement -->
        @if (badgeStats$ | async; as stats) {
        <div class="welcome-section">
            <h1 class="handwriting">Tes troph√©es ! üèÜ</h1>
            <p class="comfort-text">Tu as d√©bloqu√© {{ stats.unlockedBadges }} badges sur {{ stats.totalBadges }}</p>

            <!-- Progression principale -->
            <div class="progress-section imperfect-element">
                <div class="progress-display">
                    <ion-progress-bar [value]="stats.completionPercentage / 100"
                        class="main-progress-bar"></ion-progress-bar>
                    <div class="progress-text">
                        <span class="percentage handwriting">{{ stats.completionPercentage }}%</span>
                        <span class="label comfort-text">de ta collection</span>
                    </div>
                </div>

                <!-- Stats par raret√© -->
                <div class="rarity-chips">
                    <div class="rarity-chip rare">
                        <div class="rarity-name">Rares</div>
                        <div class="rarity-count">
                            <ion-icon name="star-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.rare) }}
                        </div>
                    </div>
                    <div class="rarity-chip epic">
                        <div class="rarity-name">√âpiques</div>
                        <div class="rarity-count">
                            <ion-icon name="diamond-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.epic) }}
                        </div>
                    </div>
                    <div class="rarity-chip legendary">
                        <div class="rarity-name">L√©gendaires</div>
                        <div class="rarity-count">
                            <ion-icon name="trophy-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.legendary) }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="encouragement-text">
                <p class="comfort-text">{{ encouragementMessage }}</p>
                <ion-button fill="clear" size="small" (click)="shareBadgeCollection()" class="share-btn">
                    <ion-icon name="share-outline" slot="start"></ion-icon>
                    Partager ma collection
                </ion-button>
            </div>
        </div>
        }

        <!-- S√©lecteur de mode d'affichage -->
        <div class="view-mode-section">
            <div class="view-mode-buttons">
                <ion-button fill="outline" size="small"
                    (click)="setViewMode('overview')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'overview' ? 'primary' : 'medium'">
                    <ion-icon name="apps-outline" slot="start"></ion-icon>
                    Vue d'ensemble
                </ion-button>
                
                <ion-button fill="outline" size="small"
                    (click)="setViewMode('unlocked')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'unlocked' ? 'primary' : 'medium'">
                    <ion-icon name="trophy-outline" slot="start"></ion-icon>
                    Mes badges
                    <ion-badge color="success" slot="end">{{ (userBadges$ | async)?.length || 0 }}</ion-badge>
                </ion-button>
                
                <ion-button fill="outline" size="small"
                    (click)="setViewMode('category')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'category' ? 'primary' : 'medium'">
                    <ion-icon name="funnel-outline" slot="start"></ion-icon>
                    Par cat√©gorie
                </ion-button>
            </div>

            <!-- S√©lecteur de cat√©gorie (visible seulement en mode cat√©gorie) -->
            @if (viewMode === 'category') {
            <div class="category-selector">
                <ion-button fill="clear" size="small" (click)="toggleDropdown()" class="category-dropdown-btn">
                    <ion-icon [name]="getSelectedCategoryIcon()" slot="start"></ion-icon>
                    {{ getSelectedCategoryDisplayName() }}
                    <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
                </ion-button>
                
                @if (isDropdownOpen) {
                <div class="category-dropdown">
                    <ion-button fill="clear" size="small" (click)="selectCategory('all')"
                        [color]="selectedCategory === 'all' ? 'primary' : 'medium'">
                        <ion-icon name="apps" slot="start"></ion-icon>
                        Toutes les cat√©gories
                    </ion-button>
                    @for (category of availableCategories; track category) {
                    <ion-button fill="clear" size="small" (click)="selectCategory(category)"
                        [color]="selectedCategory === category ? 'primary' : 'medium'">
                        <ion-icon [name]="getCategoryIcon(category)" slot="start"></ion-icon>
                        {{ getCategoryDisplayName(category) }}
                    </ion-button>
                    }
                </div>
                }
            </div>
            }

            <!-- Info sur le mode actuel -->
            <p class="comfort-text mode-info">
                <ion-icon name="information-outline"></ion-icon>
                @if (viewMode === 'overview') {
                    Vue d'ensemble ‚Ä¢ 2-3 badges par cat√©gorie
                } @else if (viewMode === 'unlocked') {
                    Vos badges d√©bloqu√©s ‚Ä¢ Faciles √† retrouver
                } @else {
                    Filtrage par cat√©gorie ‚Ä¢ Navigation cibl√©e
                }
            </p>
        </div>

        <!-- Collection de badges -->
        <div class="badges-collection">
            @if (viewMode === 'unlocked') {
            <!-- Mode "Mes badges" - Seulement les badges d√©bloqu√©s -->
            <div class="unlocked-badges-section">
                <div class="section-header">
                    <h3 class="handwriting">
                        <ion-icon name="trophy-outline"></ion-icon>
                        Vos badges d√©bloqu√©s
                    </h3>
                    <ion-badge color="success" class="count-badge">{{ (userBadges$ | async)?.length || 0 }}</ion-badge>
                </div>
                
                @if (userBadges$ | async; as unlockedBadges) {
                    @if (unlockedBadges.length > 0) {
                    <div class="badges-grid">
                        @for (badge of unlockedBadges; track badge.id) {
                        <div class="badge-card imperfect-element unlocked"
                            [class]="'rarity-' + badge.rarity + ' category-' + badge.category.toLowerCase()">

                            <!-- Fond color√© selon la cat√©gorie -->
                            <div class="badge-background" [class]="'bg-' + badge.category.toLowerCase()"></div>

                            <!-- Ic√¥ne du badge avec style "imparfait" -->
                            <div class="badge-icon-container">
                                <div class="icon-circle imperfect-element" [class]="'circle-' + badge.rarity">
                                    <ion-icon [name]="badge.icon"
                                        [class]="'badge-icon-' + badge.rarity + ' icon-wobble'"></ion-icon>
                                </div>
                                <div class="unlock-star">‚ú®</div>
                            </div>

                            <!-- Informations du badge -->
                            <div class="badge-content">
                                <h4 class="badge-name handwriting">{{ badge.name }}</h4>
                                <p class="badge-description comfort-text">{{ badge.description }}</p>
                                <div class="badge-meta unlocked">
                                    <div class="rarity-tag imperfect-element" [class]="'tag-' + badge.rarity">
                                        <span class="comfort-text">{{ getRarityDisplayName(badge.rarity) }}</span>
                                    </div>
                                    <span class="unlock-date comfort-text">{{ badge.unlockedDate | date:'dd/MM/yy' }}</span>
                                </div>
                            </div>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-state">
                        <ion-icon name="trophy-outline" class="empty-icon"></ion-icon>
                        <p class="comfort-text">Aucun badge d√©bloqu√© pour le moment</p>
                        <p class="comfort-text">Commencez √† partager vos fails pour d√©bloquer vos premiers badges !</p>
                    </div>
                    }
                }
            </div>
            } @else {
            <!-- Mode overview ou cat√©gorie -->
            @if (getBadgesToDisplay() | async; as displayBadges) {
            <div class="all-categories">
                @for (categoryGroup of getBadgesByCategory(displayBadges) | keyvalue; track categoryGroup.key) {
                <div class="category-section">
                    <div class="category-header">
                        <h3 class="handwriting">
                            <ion-icon [name]="getCategoryIcon(categoryGroup.key)"></ion-icon>
                            {{ getCategoryDisplayName(categoryGroup.key) }}
                        </h3>
                        <ion-badge color="medium" class="count-badge">{{ categoryGroup.value.length }}</ion-badge>
                    </div>

                    <div class="badges-grid">
                        @for (badge of categoryGroup.value; track badge.id) {
                        <div class="badge-card imperfect-element"
                            [class]="'rarity-' + badge.rarity + ' category-' + badge.category.toLowerCase()"
                            [class.unlocked]="badge.unlockedDate" [class.locked]="!badge.unlockedDate">

                            <!-- Fond color√© selon la cat√©gorie -->
                            <div class="badge-background" [class]="'bg-' + badge.category.toLowerCase()"></div>

                            <!-- Ic√¥ne du badge avec style "imparfait" -->
                            <div class="badge-icon-container">
                                <div class="icon-circle imperfect-element" [class]="'circle-' + badge.rarity">
                                    <ion-icon [name]="badge.icon"
                                        [class]="'badge-icon-' + badge.rarity + ' icon-wobble'"></ion-icon>
                                </div>

                                <!-- Indicateur de d√©bloquage -->
                                @if (badge.unlockedDate) {
                                <div class="unlock-star">‚ú®</div>
                                } @else {
                                <div class="lock-overlay">
                                    <ion-icon name="lock-closed" class="lock-icon"></ion-icon>
                                </div>
                                }
                            </div>

                            <!-- Informations du badge -->
                            <div class="badge-content">
                                <h4 class="badge-name handwriting">{{ badge.name }}</h4>
                                <p class="badge-description comfort-text">{{ badge.description }}</p>

                                @if (badge.unlockedDate) {
                                <div class="badge-meta unlocked">
                                    <div class="rarity-tag imperfect-element" [class]="'tag-' + badge.rarity">
                                        <span class="comfort-text">{{ getRarityDisplayName(badge.rarity) }}</span>
                                    </div>
                                    <span class="unlock-date comfort-text">{{ badge.unlockedDate | date:'dd/MM/yy'
                                        }}</span>
                                </div>
                                } @else {
                                <div class="badge-meta locked">
                                    <div class="progress-hint comfort-text">
                                        <ion-icon name="hourglass-outline"></ion-icon>
                                        √Ä d√©bloquer
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
            }
            }
        </div>

        <!-- Progression vers les prochains badges -->
        <div class="next-objectives">
            <h3 class="handwriting">Prochains d√©fis ! üéØ</h3>
            <div class="objectives-list">
                @for (challenge of nextChallenges$ | async; track challenge.name) {
                <div class="objective-item imperfect-element">
                    <div class="objective-info">
                        <h4>{{challenge.description}}</h4>
                        <p class="comfort-text">Badge "{{challenge.name}}" ({{getRarityDisplayName(challenge.rarity)}})
                        </p>
                    </div>
                    <div class="objective-progress">
                        <ion-progress-bar [value]="challenge.progress" class="progress-bar"></ion-progress-bar>
                        <span class="progress-text comfort-text">{{challenge.current}}/{{challenge.required}}</span>
                    </div>
                </div>
                } @empty {
                <div class="objective-item imperfect-element">
                    <div class="objective-info">
                        <h4>Tous les badges d√©bloqu√©s !</h4>
                        <p class="comfort-text">F√©licitations ! üéâ</p>
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
</ion-content>