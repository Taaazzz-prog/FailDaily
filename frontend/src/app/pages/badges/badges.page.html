<ion-header [translucent]="true">
    <ion-toolbar>
        <ion-title class="handwriting">Ma Collection de Badges</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
    <!-- Rafra√Æchissement -->
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
        <ion-refresher-content pullingIcon="chevron-down-circle-outline" pullingText="Tirer pour rafra√Æchir"
            refreshingSpinner="circles" refreshingText="Actualisation...">
        </ion-refresher-content>
    </ion-refresher>

    <div class="badges-container">
        <!-- En-t√™te d'encouragement -->
        @if (badgeStats$ | async; as stats) {
        <div class="welcome-section">
            <h1 class="handwriting">Tes troph√©es ! üèÜ</h1>
            <p class="comfort-text">Tu as d√©bloqu√© {{ stats.unlockedBadges }} badges sur {{ stats.totalBadges }}</p>

            <!-- Progression principale -->
            <div class="progress-section imperfect-element">
                <div class="progress-display">
                    <ion-progress-bar [value]="stats.completionPercentage / 100"
                        class="main-progress-bar"></ion-progress-bar>
                    <div class="progress-text">
                        <span class="percentage handwriting">{{ stats.completionPercentage }}%</span>
                        <span class="label comfort-text">de ta collection</span>
                    </div>
                </div>

                <!-- Stats par raret√© -->
                <div class="rarity-chips">
                    <div class="rarity-chip rare">
                        <div class="rarity-name">Rares</div>
                        <div class="rarity-count">
                            <ion-icon name="star-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.rare) }}
                        </div>
                    </div>
                    <div class="rarity-chip epic">
                        <div class="rarity-name">√âpiques</div>
                        <div class="rarity-count">
                            <ion-icon name="diamond-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.epic) }}
                        </div>
                    </div>
                    <div class="rarity-chip legendary">
                        <div class="rarity-name">L√©gendaires</div>
                        <div class="rarity-count">
                            <ion-icon name="trophy-outline"></ion-icon>{{ formatRarityStats(stats.rarityStats.legendary) }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="encouragement-text">
                <p class="comfort-text">{{ encouragementMessage }}</p>
                <ion-button fill="clear" size="small" (click)="shareBadgeCollection()" class="share-btn">
                    <ion-icon name="share-outline" slot="start"></ion-icon>
                    Partager ma collection
                </ion-button>
            </div>
        </div>
        }

        <!-- S√©lecteur de mode d'affichage -->
        <div class="view-mode-section">
            <div class="view-mode-buttons">
                <ion-button fill="outline" size="small"
                    (click)="setViewMode('overview')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'overview' ? 'primary' : 'medium'">
                    <ion-icon name="apps-outline" slot="start"></ion-icon>
                    Vue d'ensemble
                </ion-button>

                <ion-button fill="outline" size="small"
                    (click)="setViewMode('unlocked')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'unlocked' ? 'primary' : 'medium'">
                    <ion-icon name="trophy-outline" slot="start"></ion-icon>
                    Mes badges
                    <ion-badge color="success" slot="end">{{ (userBadges$ | async)?.length || 0 }}</ion-badge>
                </ion-button>

                <ion-button fill="outline" size="small"
                    (click)="setViewMode('category')"
                    class="view-mode-btn imperfect-element"
                    [color]="viewMode === 'category' ? 'primary' : 'medium'">
                    <ion-icon name="funnel-outline" slot="start"></ion-icon>
                    Par cat√©gorie
                </ion-button>
            </div>
        </div>

        @if (viewMode === 'unlocked') {
        <div class="unlocked-section">
            <h3 class="handwriting section-title">Badges d√©bloqu√©s ‚ú®</h3>
            @if (userBadges$ | async; as unlockedBadges) {
                @if (unlockedBadges.length > 0) {
                <div class="badges-grid">
                    @for (badge of unlockedBadges; track badge.id) {
                    <div class="badge-card unlocked imperfect-element"
                        [class]="'rarity-' + badge.rarity + ' category-' + badge.category.toLowerCase()">
                        <div class="badge-background" [class]="'bg-' + badge.category.toLowerCase()"></div>

                        <div class="badge-icon-container">
                            <div class="icon-circle imperfect-element" [class]="'circle-' + badge.rarity">
                                <ion-icon [name]="badge.icon"
                                    [class]="'badge-icon-' + badge.rarity + ' icon-wobble'"></ion-icon>
                            </div>
                            <div class="unlock-star">‚ú®</div>
                        </div>

                        <div class="badge-content">
                            <h4 class="badge-name handwriting">{{ badge.name }}</h4>
                            <p class="badge-description comfort-text">{{ badge.description }}</p>
                            <div class="badge-meta unlocked">
                                <div class="rarity-tag imperfect-element" [class]="'tag-' + badge.rarity">
                                    <span class="comfort-text">{{ getRarityDisplayName(badge.rarity) }}</span>
                                </div>
                                <span class="unlock-date comfort-text">{{ badge.unlockedDate | date:'dd/MM/yy' }}</span>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                } @else {
                <div class="empty-state">
                    <ion-icon name="trophy-outline" class="empty-icon"></ion-icon>
                    <p class="comfort-text">Aucun badge d√©bloqu√© pour le moment</p>
                    <p class="comfort-text">Commencez √† partager vos fails pour d√©bloquer vos premiers badges !</p>
                </div>
                }
            }
        </div>
        } @else if (viewMode === 'category') {
        @if (allBadges$ | async; as allBadges) {
        <ion-accordion-group class="badge-accordion" multiple="true">
            @for (categoryGroup of getBadgesByCategory(allBadges) | keyvalue; track categoryGroup.key) {
            <ion-accordion [value]="categoryGroup.key">
                <ion-item slot="header" lines="none" class="category-accordion-header imperfect-element">
                    <ion-icon slot="start" [name]="getCategoryIcon(categoryGroup.key)"></ion-icon>
                    <ion-label>{{ getCategoryDisplayName(categoryGroup.key) }}</ion-label>
                    <ion-badge slot="end" color="medium">{{ categoryGroup.value.length }}</ion-badge>
                </ion-item>
                <div class="accordion-content" slot="content">
                    <div class="badges-grid">
                        @for (badge of categoryGroup.value; track badge.id) {
                        <div class="badge-card imperfect-element"
                            [class]="'rarity-' + badge.rarity + ' category-' + badge.category.toLowerCase()"
                            [class.unlocked]="badge.unlockedDate" [class.locked]="!badge.unlockedDate">

                            <div class="badge-background" [class]="'bg-' + badge.category.toLowerCase()"></div>

                            <div class="badge-icon-container">
                                <div class="icon-circle imperfect-element" [class]="'circle-' + badge.rarity">
                                    <ion-icon [name]="badge.icon"
                                        [class]="'badge-icon-' + badge.rarity + ' icon-wobble'"></ion-icon>
                                </div>
                                @if (badge.unlockedDate) {
                                <div class="unlock-star">‚ú®</div>
                                } @else {
                                <div class="lock-overlay">
                                    <ion-icon name="lock-closed" class="lock-icon"></ion-icon>
                                </div>
                                }
                            </div>

                            <div class="badge-content">
                                <h4 class="badge-name handwriting">{{ badge.name }}</h4>
                                <p class="badge-description comfort-text">{{ badge.description }}</p>

                                @if (badge.unlockedDate) {
                                <div class="badge-meta unlocked">
                                    <div class="rarity-tag imperfect-element" [class]="'tag-' + badge.rarity">
                                        <span class="comfort-text">{{ getRarityDisplayName(badge.rarity) }}</span>
                                    </div>
                                    <span class="unlock-date comfort-text">{{ badge.unlockedDate | date:'dd/MM/yy' }}</span>
                                </div>
                                } @else {
                                <div class="badge-meta locked">
                                    <div class="progress-hint comfort-text">
                                        <ion-icon name="hourglass-outline"></ion-icon>
                                        √Ä d√©bloquer
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </ion-accordion>
            }
        </ion-accordion-group>
        }
        } @else {
        <div class="overview-placeholder imperfect-element">
            <h3 class="handwriting">Explore tes cat√©gories de badges üåà</h3>
            <p class="comfort-text">Consulte tes badges d√©bloqu√©s ou ouvre le mode "Par cat√©gorie" pour explorer chaque collection.</p>
            <ion-button fill="outline" size="small" (click)="setViewMode('category')">
                <ion-icon name="funnel-outline" slot="start"></ion-icon>
                Voir les cat√©gories
            </ion-button>
        </div>
        }

        <!-- Progression vers les prochains badges -->
        @if (viewMode === 'overview') {
        <div class="next-objectives">
            <h3 class="handwriting">Prochains d√©fis ! üéØ</h3>
            <div class="objectives-list">
                @for (challenge of nextChallenges$ | async; track challenge.name) {
                <div class="objective-item imperfect-element">
                    <div class="objective-info">
                        <h4>{{challenge.description}}</h4>
                        <p class="comfort-text">Badge "{{challenge.name}}" ({{getRarityDisplayName(challenge.rarity)}})
                        </p>
                    </div>
                    <div class="objective-progress">
                        <ion-progress-bar [value]="challenge.progress" class="progress-bar"></ion-progress-bar>
                        <span class="progress-text comfort-text">{{challenge.current}}/{{challenge.required}}</span>
                    </div>
                </div>
                } @empty {
                <div class="objective-item imperfect-element">
                    <div class="objective-info">
                        <h4>Aucun d√©fi en cours üåü</h4>
                        <p class="comfort-text">Commencez par partager votre premier fail pour d√©bloquer des badges ! Votre premier objectif : obtenir le badge "Premier Pas" üë£</p>
                    </div>
                </div>
                }
            </div>
        </div>
        }
        </div>
    </div>
</ion-content>