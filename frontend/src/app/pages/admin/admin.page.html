<ion-header>
    <ion-toolbar>
        <ion-title>üõ†Ô∏è Panneau d'Administration</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="refresh()">
                <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content>
    <!-- Refresher -->
    <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Segments pour navigation -->
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChanged($event)">
        <ion-segment-button value="dashboard">
            <ion-icon name="stats-chart-outline"></ion-icon>
            <ion-label>Dashboard</ion-label>
        </ion-segment-button>
        <ion-segment-button value="config">
            <ion-icon name="settings-outline"></ion-icon>
            <ion-label>Config</ion-label>
        </ion-segment-button>
        <ion-segment-button value="users">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>Utilisateurs</ion-label>
        </ion-segment-button>
        <ion-segment-button value="logs">
            <ion-icon name="bug-outline"></ion-icon>
            <ion-label>Logs</ion-label>
        </ion-segment-button>
        <ion-segment-button value="realtime">
            <ion-icon name="eye-outline"></ion-icon>
            <ion-label>Temps R√©el</ion-label>
        </ion-segment-button>
        <ion-segment-button value="database">
            <ion-icon name="trash-outline"></ion-icon>
            <ion-label>Base de Donn√©es</ion-label>
        </ion-segment-button>
    </ion-segment>

    <!-- DASHBOARD SECTION -->
    @if (selectedSegment === 'dashboard') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>
                üìä Statistiques G√©n√©rales
                @if (loading) {
                <ion-spinner name="dots"></ion-spinner>
                }
            </ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <ion-grid>
                <ion-row>
                    <ion-col size="6">
                        <div class="stat-card">
                            <h3>{{ dashboardStats.totalUsers }}</h3>
                            <p>Utilisateurs Totaux</p>
                        </div>
                    </ion-col>
                    <ion-col size="6">
                        <div class="stat-card">
                            <h3>{{ dashboardStats.totalFails }}</h3>
                            <p>Fails Totaux</p>
                        </div>
                    </ion-col>
                </ion-row>
                <ion-row>
                    <ion-col size="6">
                        <div class="stat-card">
                            <h3>{{ dashboardStats.totalReactions }}</h3>
                            <p>R√©actions Totales</p>
                        </div>
                    </ion-col>
                    <ion-col size="6">
                        <div class="stat-card">
                            <h3>{{ dashboardStats.todayActivity }}</h3>
                            <p>Activit√© Aujourd'hui</p>
                        </div>
                    </ion-col>
                </ion-row>
            </ion-grid>

            <div class="system-status">
                <ion-chip [color]="getStatusColor(dashboardStats.systemStatus)">
                    @if (dashboardStats.systemStatus === 'healthy') {
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    }
                    @if (dashboardStats.systemStatus === 'warning') {
                    <ion-icon name="warning-outline"></ion-icon>
                    }
                    @if (dashboardStats.systemStatus === 'error') {
                    <ion-icon name="close-circle-outline"></ion-icon>
                    }
                    <ion-label>Statut: {{ dashboardStats.systemStatus }}</ion-label>
                </ion-chip>
            </div>

            <ion-button expand="block" (click)="analyzeDatabase()" [disabled]="loading">
                <ion-icon name="information-circle-outline" slot="start"></ion-icon>
                Analyser la Base de Donn√©es
            </ion-button>

            <!-- R√©sultats de l'analyse de la base de donn√©es -->
            @if (showAnalysisResults && databaseAnalysis) {
            <ion-card color="light" class="analysis-results-card">
                <ion-card-header>
                    <ion-card-title>
                        <ion-icon name="analytics-outline" slot="start"></ion-icon>
                        R√©sultats d'Analyse de la Base
                        <ion-chip [color]="getAnalysisStatusColor()" slot="end">
                            {{ getAnalysisStatusText() }}
                        </ion-chip>
                    </ion-card-title>
                    <ion-card-subtitle>
                        Analys√© le {{ formatTimestamp(databaseAnalysis.timestamp) }}
                    </ion-card-subtitle>
                </ion-card-header>

                <ion-card-content>
                    @if (databaseAnalysis.error) {
                    <div class="error-section">
                        <ion-icon name="warning-outline" color="danger"></ion-icon>
                        <p><strong>Erreur:</strong> {{ databaseAnalysis.errorMessage }}</p>
                    </div>
                    } @else {
                    <!-- Statistiques globales -->
                    <div class="stats-section">
                        <h4>üìä Statistiques Globales</h4>
                        <ion-grid>
                            <ion-row>
                                <ion-col size="6" size-md="3">
                                    <div class="analysis-stat">
                                        <h3>{{ databaseAnalysis.globalStats.totalProfiles }}</h3>
                                        <p>Profils</p>
                                    </div>
                                </ion-col>
                                <ion-col size="6" size-md="3">
                                    <div class="analysis-stat">
                                        <h3>{{ databaseAnalysis.globalStats.totalFails }}</h3>
                                        <p>Fails</p>
                                    </div>
                                </ion-col>
                                <ion-col size="6" size-md="3">
                                    <div class="analysis-stat">
                                        <h3>{{ databaseAnalysis.globalStats.totalReactions }}</h3>
                                        <p>R√©actions</p>
                                    </div>
                                </ion-col>
                                <ion-col size="6" size-md="3">
                                    <div class="analysis-stat">
                                        <h3>{{ databaseAnalysis.globalStats.totalSystemLogs }}</h3>
                                        <p>Logs</p>
                                    </div>
                                </ion-col>
                            </ion-row>
                        </ion-grid>
                    </div>

                    <!-- Probl√®mes d'int√©grit√© -->
                    <div class="integrity-section">
                        <h4>üîç Probl√®mes d'Int√©grit√©</h4>
                        <ion-list>
                            <ion-item>
                                <ion-icon name="link-outline" slot="start"
                                    [color]="databaseAnalysis.integrityIssues.orphanedReactions > 0 ? 'warning' : 'success'"></ion-icon>
                                <ion-label>
                                    <h3>R√©actions Orphelines</h3>
                                    <p>{{ databaseAnalysis.integrityIssues.orphanedReactions }} r√©actions sans fail
                                        correspondant</p>
                                </ion-label>
                                <ion-chip
                                    [color]="databaseAnalysis.integrityIssues.orphanedReactions > 0 ? 'warning' : 'success'"
                                    slot="end">
                                    {{ databaseAnalysis.integrityIssues.orphanedReactions }}
                                </ion-chip>
                            </ion-item>

                            <ion-item>
                                <ion-icon name="mail-outline" slot="start"
                                    [color]="databaseAnalysis.integrityIssues.profilesWithoutEmail > 0 ? 'warning' : 'success'"></ion-icon>
                                <ion-label>
                                    <h3>Profils sans Email</h3>
                                    <p>{{ databaseAnalysis.integrityIssues.profilesWithoutEmail }} profils avec email
                                        manquant</p>
                                </ion-label>
                                <ion-chip
                                    [color]="databaseAnalysis.integrityIssues.profilesWithoutEmail > 0 ? 'warning' : 'success'"
                                    slot="end">
                                    {{ databaseAnalysis.integrityIssues.profilesWithoutEmail }}
                                </ion-chip>
                            </ion-item>

                            <ion-item>
                                <ion-icon name="calculator-outline" slot="start"
                                    [color]="databaseAnalysis.integrityIssues.inconsistentReactionCounts > 0 ? 'warning' : 'success'"></ion-icon>
                                <ion-label>
                                    <h3>Compteurs Incoh√©rents</h3>
                                    <p>{{ databaseAnalysis.integrityIssues.inconsistentReactionCounts }} fails avec
                                        compteurs incorrects</p>
                                </ion-label>
                                <ion-chip
                                    [color]="databaseAnalysis.integrityIssues.inconsistentReactionCounts > 0 ? 'warning' : 'success'"
                                    slot="end">
                                    {{ databaseAnalysis.integrityIssues.inconsistentReactionCounts }}
                                </ion-chip>
                            </ion-item>

                            <ion-item>
                                <ion-icon name="stats-chart-outline" slot="start"
                                    [color]="databaseAnalysis.integrityIssues.usersWithoutStats > 0 ? 'warning' : 'success'"></ion-icon>
                                <ion-label>
                                    <h3>Utilisateurs sans Stats</h3>
                                    <p>{{ databaseAnalysis.integrityIssues.usersWithoutStats }} utilisateurs sans
                                        statistiques</p>
                                </ion-label>
                                <ion-chip
                                    [color]="databaseAnalysis.integrityIssues.usersWithoutStats > 0 ? 'warning' : 'success'"
                                    slot="end">
                                    {{ databaseAnalysis.integrityIssues.usersWithoutStats }}
                                </ion-chip>
                            </ion-item>
                        </ion-list>
                    </div>

                    <!-- Activit√© r√©cente -->
                    <div class="recent-activity-section">
                        <h4>üìà Activit√© (24h)</h4>
                        <ion-grid>
                            <ion-row>
                                <ion-col size="4">
                                    <div class="activity-stat">
                                        <h3>{{ databaseAnalysis.recentActivity.newFailsLast24h }}</h3>
                                        <p>Nouveaux Fails</p>
                                    </div>
                                </ion-col>
                                <ion-col size="4">
                                    <div class="activity-stat">
                                        <h3>{{ databaseAnalysis.recentActivity.newReactionsLast24h }}</h3>
                                        <p>Nouvelles R√©actions</p>
                                    </div>
                                </ion-col>
                                <ion-col size="4">
                                    <div class="activity-stat">
                                        <h3>{{ databaseAnalysis.recentActivity.newUsersLast24h }}</h3>
                                        <p>Nouveaux Utilisateurs</p>
                                    </div>
                                </ion-col>
                            </ion-row>
                        </ion-grid>
                    </div>

                    <!-- Recommandations -->
                    @if (databaseAnalysis.recommendations && databaseAnalysis.recommendations.length > 0) {
                    <div class="recommendations-section">
                        <h4>üí° Recommandations</h4>
                        <ion-list>
                            <ion-item *ngFor="let recommendation of databaseAnalysis.recommendations">
                                <ion-icon name="bulb-outline" slot="start" color="warning"></ion-icon>
                                <ion-label>{{ recommendation }}</ion-label>
                            </ion-item>
                        </ion-list>
                    </div>
                    }

                    <!-- Fails probl√©matiques (si il y en a) -->
                    @if (databaseAnalysis.integrityIssues.problematicFails &&
                    databaseAnalysis.integrityIssues.problematicFails.length > 0) {
                    <div class="problematic-fails-section">
                        <div class="section-header">
                            <h4>‚ö†Ô∏è Fails Probl√©matiques (Top 10)</h4>
                            <ion-button fill="outline" size="small" (click)="fixAllProblematicFails()"
                                [disabled]="loading" color="warning">
                                <ion-icon name="hammer-outline" slot="start"></ion-icon>
                                Corriger Tout
                            </ion-button>
                        </div>
                        <ion-list>
                            <ion-item *ngFor="let fail of databaseAnalysis.integrityIssues.problematicFails">
                                <ion-icon name="warning-outline" slot="start" color="warning"></ion-icon>
                                <ion-label>
                                    <h3>{{ fail.title }}</h3>
                                    <p>Compteur stock√©: {{ fail.storedCount }} | R√©el: {{ fail.actualCount }} |
                                        Diff√©rence: {{ fail.difference }}</p>
                                    <p class="fail-id"><small>ID: {{ fail.id }}</small></p>
                                </ion-label>
                                <div slot="end" class="fail-actions">
                                    <ion-button fill="clear" size="small" (click)="analyzeProblematicFail(fail)"
                                        [disabled]="loading" color="primary">
                                        <ion-icon name="analytics-outline" slot="icon-only"></ion-icon>
                                    </ion-button>
                                    <ion-button fill="clear" size="small" (click)="fixProblematicFail(fail)"
                                        [disabled]="loading" color="success">
                                        <ion-icon name="checkmark-circle-outline" slot="icon-only"></ion-icon>
                                    </ion-button>
                                </div>
                            </ion-item>
                        </ion-list>
                    </div>
                    }
                    }

                    <div class="actions-section">
                        <ion-button expand="block" fill="clear" (click)="closeAnalysisResults()">
                            <ion-icon name="close-outline" slot="start"></ion-icon>
                            Fermer l'Analyse
                        </ion-button>
                    </div>
                </ion-card-content>
            </ion-card>
            }
        </ion-card-content>
    </ion-card>
    }

    <!-- CONFIGURATION SECTION -->
    @if (selectedSegment === 'config') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>‚öôÔ∏è Configuration des Points</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <ion-item>
                <ion-label position="stacked">Points pour cr√©er un Fail</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.createFailPoints"></ion-input>
            </ion-item>

            <ion-item>
                <ion-label position="stacked">Points r√©action Courage</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.courageReactionPoints"></ion-input>
            </ion-item>

            <ion-item>
                <ion-label position="stacked">Points r√©action Rire</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.laughReactionPoints"></ion-input>
            </ion-item>

            <ion-item>
                <ion-label position="stacked">Points r√©action Empathie</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.empathyReactionPoints"></ion-input>
            </ion-item>

            <ion-item>
                <ion-label position="stacked">Points r√©action Soutien</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.supportReactionPoints"></ion-input>
            </ion-item>

            <ion-item>
                <ion-label position="stacked">Bonus quotidien</ion-label>
                <ion-input type="number" [(ngModel)]="pointsConfig.dailyBonusPoints"></ion-input>
            </ion-item>

            <div class="button-group">
                <ion-button expand="block" (click)="savePointsConfiguration()">
                    <ion-icon name="save-outline" slot="start"></ion-icon>
                    Sauvegarder Configuration
                </ion-button>

                <ion-button expand="block" fill="outline" (click)="resetPointsConfiguration()">
                    <ion-icon name="refresh-outline" slot="start"></ion-icon>
                    R√©initialiser
                </ion-button>
            </div>
        </ion-card-content>
    </ion-card>
    }

    <!-- USERS SECTION -->
    @if (selectedSegment === 'users') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>üë• Gestion Compl√®te des Utilisateurs</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <!-- Liste des utilisateurs -->
            <h4>üë§ Tous les Utilisateurs</h4>
            <ion-list>
                <ion-item *ngFor="let user of allUsers">
                    <ion-avatar slot="start">
                        <img [src]="user.avatar_url || '/assets/profil/base.png'" alt="Avatar">
                    </ion-avatar>
                    <ion-label>
                        <h3>{{ user.display_name || user.username }}</h3>
                        <p>{{ user.email }}</p>
                        <p><small>R√¥le: {{ user.role || 'user' }} | Points: {{ user.points || 0 }}</small></p>
                    </ion-label>

                    <ion-button fill="clear" size="small" (click)="showUserActions(user)" slot="end">
                        <ion-icon name="settings-outline"></ion-icon>
                    </ion-button>
                </ion-item>
            </ion-list>

            <!-- Section des actions utilisateur -->
            @if (selectedUser) {
            <div class="user-management-section">
                <ion-card color="light">
                    <ion-card-header>
                        <ion-card-title>‚öôÔ∏è Gestion de {{ selectedUser.display_name || selectedUser.username
                            }}</ion-card-title>
                    </ion-card-header>
                    <ion-card-content>
                        <!-- Modifier le compte -->
                        <h5>üìù Modifier le Compte</h5>
                        <ion-item>
                            <ion-label position="stacked">Nom d'affichage</ion-label>
                            <ion-input [(ngModel)]="userEditForm.display_name"></ion-input>
                        </ion-item>
                        <ion-item>
                            <ion-label position="stacked">R√¥le</ion-label>
                            <ion-select [(ngModel)]="userEditForm.role">
                                <ion-select-option value="user">Utilisateur</ion-select-option>
                                <ion-select-option value="admin">Administrateur</ion-select-option>
                                <ion-select-option value="moderator">Mod√©rateur</ion-select-option>
                            </ion-select>
                        </ion-item>
                        <ion-item>
                            <ion-label position="stacked">Points</ion-label>
                            <ion-input type="number" [(ngModel)]="userEditForm.points"></ion-input>
                        </ion-item>
                        <ion-item>
                            <ion-label position="stacked">Raison de la modification</ion-label>
                            <ion-textarea [(ngModel)]="userEditForm.reason"
                                placeholder="Pourquoi modifier ce compte?"></ion-textarea>
                        </ion-item>

                        <div class="button-group">
                            <ion-button expand="block" color="primary" (click)="updateUserAccount()">
                                <ion-icon name="save-outline" slot="start"></ion-icon>
                                Sauvegarder les Modifications
                            </ion-button>
                        </div>

                        <!-- Actions sur les donn√©es utilisateur -->
                        <h5>üóëÔ∏è Actions sur les Donn√©es</h5>
                        <div class="dangerous-actions">
                            <ion-button expand="block" color="warning" fill="outline" (click)="showUserReactions()">
                                <ion-icon name="heart-outline" slot="start"></ion-icon>
                                G√©rer les R√©actions ({{ userReactionsCount }})
                            </ion-button>

                            <ion-button expand="block" color="warning" fill="outline" (click)="showUserFails()">
                                <ion-icon name="warning-outline" slot="start"></ion-icon>
                                G√©rer les Fails ({{ userFailsCount }})
                            </ion-button>
                        </div>

                        <ion-button expand="block" color="medium" fill="clear" (click)="hideUserActions()">
                            <ion-icon name="close-outline" slot="start"></ion-icon>
                            Fermer
                        </ion-button>
                    </ion-card-content>
                </ion-card>
            </div>
            }

            <!-- Modal pour les r√©actions -->
            @if (showReactionsModal) {
            <div class="modal-content">
                <ion-card>
                    <ion-card-header>
                        <ion-card-title>‚ù§Ô∏è R√©actions de {{ selectedUser.display_name }}</ion-card-title>
                    </ion-card-header>
                    <ion-card-content>
                        <ion-list>
                            <ion-item *ngFor="let reaction of userReactions">
                                <ion-icon [name]="getReactionIcon(reaction.reaction_type)" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>{{ reaction.reaction_type }}</h3>
                                    <p>Sur: {{ reaction.fail_title }}</p>
                                    <p><small>{{ formatTimestamp(reaction.created_at) }}</small></p>
                                </ion-label>
                                <ion-button color="danger" fill="clear" size="small"
                                    (click)="deleteReactionConfirm(reaction)" slot="end">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </ion-button>
                            </ion-item>
                        </ion-list>
                        <ion-button fill="clear" (click)="showReactionsModal = false">Fermer</ion-button>
                    </ion-card-content>
                </ion-card>
            </div>
            }

            <!-- Modal pour les fails -->
            @if (showFailsModal) {
            <div class="modal-content">
                <ion-card>
                    <ion-card-header>
                        <ion-card-title>üí£ Fails de {{ selectedUser.display_name }}</ion-card-title>
                    </ion-card-header>
                    <ion-card-content>
                        <ion-list>
                            <ion-item *ngFor="let fail of userFails">
                                <ion-label>
                                    <h3>{{ fail.title }}</h3>
                                    <p>{{ fail.description }}</p>
                                    <p><small>{{ formatTimestamp(fail.created_at) }} - {{ fail.reactions_count }}
                                            r√©actions</small></p>
                                </ion-label>
                                <ion-button color="danger" fill="clear" size="small" (click)="deleteFailConfirm(fail)"
                                    slot="end">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </ion-button>
                            </ion-item>
                        </ion-list>
                        <ion-button fill="clear" (click)="showFailsModal = false">Fermer</ion-button>
                    </ion-card-content>
                </ion-card>
            </div>
            }
        </ion-card-content>
    </ion-card>
    }

    <!-- LOGS SECTION - NOUVEAU SYST√àME ULTRA-COMPLET -->
    @if (selectedSegment === 'logs') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>
                ÔøΩ Syst√®me de Logs Ultra-Complet
                <ion-buttons slot="end">
                    <ion-button (click)="toggleRealTimeLogs()" [color]="isRealTimeLogsEnabled ? 'success' : 'medium'">
                        <ion-icon [name]="isRealTimeLogsEnabled ? 'radio' : 'radio-outline'"></ion-icon>
                    </ion-button>
                    <ion-button (click)="exportComprehensiveLogs()">
                        <ion-icon name="download-outline"></ion-icon>
                    </ion-button>
                    <ion-button (click)="refreshComprehensiveLogs()">
                        <ion-icon name="refresh-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-card-title>
            <ion-card-subtitle>
                Syst√®me PostgreSQL avec granularit√© ultra-fine
            </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <!-- Sous-onglets Logs Admin -->
            <ion-segment [(ngModel)]="selectedLogTab" (ionChange)="onLogTabChanged($event)" mode="md" class="ion-margin-bottom">
                <ion-segment-button value="summary"><ion-label>R√©sum√©</ion-label></ion-segment-button>
                <ion-segment-button value="by-day"><ion-label>Par jour</ion-label></ion-segment-button>
                <ion-segment-button value="by-user"><ion-label>Par utilisateur</ion-label></ion-segment-button>
                <ion-segment-button value="by-action"><ion-label>Par action</ion-label></ion-segment-button>
                <ion-segment-button value="list"><ion-label>Liste</ion-label></ion-segment-button>
            </ion-segment>

            <!-- R√©sum√© -->
            @if (selectedLogTab === 'summary') {
            <ion-grid class="ion-margin-bottom">
                <ion-row>
                    <ion-col size="6" size-md="3"><ion-card class="stats-card"><ion-card-content class="ion-text-center"><h2>{{ logsSummary?.totals?.total || 0 }}</h2><p>Total</p></ion-card-content></ion-card></ion-col>
                    <ion-col size="6" size-md="3"><ion-card class="stats-card"><ion-card-content class="ion-text-center"><h2>{{ logsSummary?.totals?.errors || 0 }}</h2><p>Erreurs</p></ion-card-content></ion-card></ion-col>
                    <ion-col size="6" size-md="3"><ion-card class="stats-card"><ion-card-content class="ion-text-center"><h2>{{ logsSummary?.totals?.warnings || 0 }}</h2><p>Warnings</p></ion-card-content></ion-card></ion-col>
                    <ion-col size="6" size-md="3"><ion-card class="stats-card"><ion-card-content class="ion-text-center"><h2>{{ logsSummary?.totals?.infos || 0 }}</h2><p>Infos</p></ion-card-content></ion-card></ion-col>
                </ion-row>
            </ion-grid>
            <ion-list>
                <ion-list-header><ion-label>Top actions ({{ logDays }} jours)</ion-label>
                    <ion-buttons slot="end">
                        <ion-button size="small" (click)="onLogDaysChanged(1)" [color]="logDays===1 ? 'primary' : 'medium'">1j</ion-button>
                        <ion-button size="small" (click)="onLogDaysChanged(7)" [color]="logDays===7 ? 'primary' : 'medium'">7j</ion-button>
                        <ion-button size="small" (click)="onLogDaysChanged(30)" [color]="logDays===30 ? 'primary' : 'medium'">30j</ion-button>
                    </ion-buttons>
                </ion-list-header>
                <ion-item *ngFor="let a of logsSummary?.topActions">
                    <ion-icon [name]="getActionIcon(a.action)" [color]="getActionColor(a.action)" slot="start"></ion-icon>
                    <ion-label>{{ a.action || '‚Äî' }}</ion-label>
                    <ion-chip [color]="getActionColor(a.action)" slot="end">{{ a.count }}</ion-chip>
                </ion-item>
            </ion-list>
            }

            <!-- Par jour -->
            @if (selectedLogTab === 'by-day') {
            <ion-list>
                <ion-item *ngFor="let d of logsByDay">
                    <ion-label>
                        <h3>{{ d.day | date:'mediumDate' }}</h3>
                        <p>Total: {{ d.total }}</p>
                    </ion-label>
                    <ion-badge color="danger" slot="end">Err {{ d.errors }}</ion-badge>
                    <ion-badge color="warning" slot="end" class="ion-margin-start">Warn {{ d.warnings }}</ion-badge>
                    <ion-badge color="primary" slot="end" class="ion-margin-start">Info {{ d.infos }}</ion-badge>
                </ion-item>
            </ion-list>
            }

            <!-- Par utilisateur -->
            @if (selectedLogTab === 'by-user') {
            <ion-list>
                <ion-item *ngFor="let u of logsByUser">
                    <ion-avatar slot="start"><ion-icon name="person-outline"></ion-icon></ion-avatar>
                    <ion-label>
                        <h3>{{ u.display_name || u.email || u.user_id }}</h3>
                        <p>Total: {{ u.total }}</p>
                    </ion-label>
                    <ion-badge color="danger" slot="end">Err {{ u.errors }}</ion-badge>
                    <ion-badge color="warning" slot="end" class="ion-margin-start">Warn {{ u.warnings }}</ion-badge>
                    <ion-badge color="primary" slot="end" class="ion-margin-start">Info {{ u.infos }}</ion-badge>
                </ion-item>
            </ion-list>
            }

            <!-- Par action -->
            @if (selectedLogTab === 'by-action') {
            <ion-list>
                <ion-item *ngFor="let ac of logsActions">
                    <ion-icon [name]="getActionIcon(ac.action)" [color]="getActionColor(ac.action)" slot="start"></ion-icon>
                    <ion-label>{{ ac.action || '‚Äî' }}</ion-label>
                    <ion-chip [color]="getActionColor(ac.action)" slot="end">{{ ac.count }}</ion-chip>
                </ion-item>
            </ion-list>
            }

            <!-- Filtres Avanc√©s (ancien) - cach√©s par d√©faut -->
            @if (false) {
            <ion-grid class="ion-margin-bottom">
                <ion-row>
                    <ion-col size="12" size-md="3">
                        <ion-item>
                            <ion-label position="stacked">Type d'Activit√©</ion-label>
                            <ion-select [(ngModel)]="logFilters.activityType" (selectionChange)="applyLogFilters()">
                                <ion-select-option value="">Tous</ion-select-option>
                                <ion-select-option value="auth">Authentification</ion-select-option>
                                <ion-select-option value="user_action">Actions Utilisateur</ion-select-option>
                                <ion-select-option value="admin">Administration</ion-select-option>
                                <ion-select-option value="security">S√©curit√©</ion-select-option>
                                <ion-select-option value="performance">Performance</ion-select-option>
                                <ion-select-option value="error">Erreurs</ion-select-option>
                            </ion-select>
                        </ion-item>
                    </ion-col>
                    <ion-col size="12" size-md="3">
                        <ion-item>
                            <ion-label position="stacked">Niveau</ion-label>
                            <ion-select [(ngModel)]="logFilters.level" (selectionChange)="applyLogFilters()">
                                <ion-select-option value="">Tous</ion-select-option>
                                <ion-select-option value="info">Info</ion-select-option>
                                <ion-select-option value="warning">Warning</ion-select-option>
                                <ion-select-option value="error">Erreur</ion-select-option>
                                <ion-select-option value="critical">Critique</ion-select-option>
                            </ion-select>
                        </ion-item>
                    </ion-col>
                    <ion-col size="12" size-md="3">
                        <ion-item>
                            <ion-label position="stacked">P√©riode</ion-label>
                            <ion-select [(ngModel)]="logFilters.period" (selectionChange)="applyLogFilters()">
                                <ion-select-option value="1h">Derni√®re heure</ion-select-option>
                                <ion-select-option value="24h">Derni√®res 24h</ion-select-option>
                                <ion-select-option value="7d">7 derniers jours</ion-select-option>
                                <ion-select-option value="30d">30 derniers jours</ion-select-option>
                                <ion-select-option value="custom">Personnalis√©</ion-select-option>
                            </ion-select>
                        </ion-item>
                    </ion-col>
                    <ion-col size="12" size-md="3">
                        <ion-item>
                            <ion-label position="stacked">Utilisateur</ion-label>
                            <ion-input [(ngModel)]="logFilters.userId" placeholder="ID ou email" (ionInput)="applyLogFilters()"></ion-input>
                        </ion-item>
                    </ion-col>
                </ion-row>
            </ion-grid>
            }

            <!-- Statistiques en Temps R√©el -->
            <ion-grid class="ion-margin-bottom">
                <ion-row>
                    <ion-col size="6" size-md="3">
                        <ion-card class="stats-card">
                            <ion-card-content class="ion-text-center">
                                <ion-icon name="pulse-outline" size="large" color="success"></ion-icon>
                                <h2>{{ logsStats.totalToday | number }}</h2>
                                <p>Actions Aujourd'hui</p>
                            </ion-card-content>
                        </ion-card>
                    </ion-col>
                    <ion-col size="6" size-md="3">
                        <ion-card class="stats-card">
                            <ion-card-content class="ion-text-center">
                                <ion-icon name="warning-outline" size="large" color="warning"></ion-icon>
                                <h2>{{ logsStats.errorsToday | number }}</h2>
                                <p>Erreurs Aujourd'hui</p>
                            </ion-card-content>
                        </ion-card>
                    </ion-col>
                    <ion-col size="6" size-md="3">
                        <ion-card class="stats-card">
                            <ion-card-content class="ion-text-center">
                                <ion-icon name="people-outline" size="large" color="primary"></ion-icon>
                                <h2>{{ logsStats.activeUsers | number }}</h2>
                                <p>Utilisateurs Actifs</p>
                            </ion-card-content>
                        </ion-card>
                    </ion-col>
                    <ion-col size="6" size-md="3">
                        <ion-card class="stats-card">
                            <ion-card-content class="ion-text-center">
                                <ion-icon name="speedometer-outline" size="large" color="tertiary"></ion-icon>
                                <h2>{{ logsStats.avgResponseTime | number:'1.0-2' }}ms</h2>
                                <p>Temps Moyen</p>
                            </ion-card-content>
                        </ion-card>
                    </ion-col>
                </ion-row>
            </ion-grid>

            <!-- Table des Logs Comprehensive -->
            <div class="logs-table-container">
                @if (comprehensiveLogs.length > 0) {
                <ion-list>
                    @for (log of comprehensiveLogs; track log.id) {
                    <ion-item-sliding>
                        <ion-item>
                            <ion-avatar slot="start">
                                @switch (log.activity_type) {
                                    @case ('auth') { <ion-icon name="key-outline" color="primary"></ion-icon> }
                                    @case ('user_action') { <ion-icon name="hand-left-outline" color="tertiary"></ion-icon> }
                                    @case ('admin') { <ion-icon name="shield-outline" color="warning"></ion-icon> }
                                    @case ('security') { <ion-icon name="alert-outline" color="danger"></ion-icon> }
                                    @case ('error') { <ion-icon name="bug-outline" color="danger"></ion-icon> }
                                    @default { <ion-icon name="information-outline" color="medium"></ion-icon> }
                                }
                            </ion-avatar>
                            <ion-label>
                                <h2>
                                    {{ log.activity_type | titlecase }} 
                                    <ion-badge [color]="getLogLevelColor(log.level)">{{ log.level }}</ion-badge>
                                </h2>
                                <h3>{{ log.description }}</h3>
                                <p>
                                    <strong>Utilisateur:</strong> {{ log.user_email || 'Syst√®me' }} |
                                    <strong>IP:</strong> {{ log.ip_address }} |
                                    <strong>Agent:</strong> {{ log.user_agent?.substring(0, 50) }}...
                                </p>
                                <p>
                                    <ion-icon name="time-outline"></ion-icon>
                                    {{ log.created_at | date:'dd/MM/yyyy HH:mm:ss' }}
                                    @if (log.duration_ms) {
                                        | <ion-icon name="speedometer-outline"></ion-icon> {{ log.duration_ms }}ms
                                    }
                                </p>
                            </ion-label>
                        </ion-item>
                        
                        <ion-item-options slot="end">
                            <ion-item-option color="primary" (click)="viewLogDetails(log)">
                                <ion-icon name="eye-outline"></ion-icon>
                                D√©tails
                            </ion-item-option>
                            @if (log.user_id) {
                            <ion-item-option color="tertiary" (click)="viewUserLogs(log.user_id)">
                                <ion-icon name="person-outline"></ion-icon>
                                Historique
                            </ion-item-option>
                            }
                        </ion-item-options>
                    </ion-item-sliding>
                    }
                </ion-list>
                } @else {
                <div class="empty-logs ion-text-center ion-padding">
                    <ion-icon name="document-outline" size="large" color="medium"></ion-icon>
                    <h3>Aucun log trouv√©</h3>
                    <p>Aucune activit√© ne correspond aux filtres s√©lectionn√©s.</p>
                </div>
                }
            </div>

            <!-- Pagination -->
            <ion-grid>
                <ion-row>
                    <ion-col class="ion-text-center">
                        <ion-button fill="outline" (click)="loadMoreLogs()" [disabled]="isLoadingLogs">
                            @if (isLoadingLogs) {
                                <ion-spinner name="crescent" slot="start"></ion-spinner>
                            }
                            Charger plus
                        </ion-button>
                    </ion-col>
                </ion-row>
            </ion-grid>
        </ion-card-content>
    </ion-card>
    }

    <!-- REAL-TIME SECTION -->
    @if (selectedSegment === 'realtime') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>
                ‚ö° Monitoring Temps R√©el
                <ion-button (click)="loadRealTimeData()" size="small" fill="clear">
                    <ion-icon name="refresh-outline"></ion-icon>
                </ion-button>
                <ion-toggle [(ngModel)]="autoRefreshEnabled" (ionChange)="toggleAutoRefresh()">
                    Auto-refresh
                </ion-toggle>
            </ion-card-title>
            <ion-card-subtitle>
                Derni√®re mise √† jour: {{ lastRealTimeUpdate | date:'short' }}
            </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <!-- Statistiques temps r√©el -->
            <ion-grid>
                <ion-row>
                    <ion-col size="4">
                        <div class="realtime-stat">
                            <h3>{{ realTimeStats.activeUsers }}</h3>
                            <p>Utilisateurs en ligne</p>
                        </div>
                    </ion-col>
                    <ion-col size="4">
                        <div class="realtime-stat">
                            <h3>{{ realTimeStats.eventsLastHour }}</h3>
                            <p>√âv√©nements/h</p>
                        </div>
                    </ion-col>
                    <ion-col size="4">
                        <div class="realtime-stat">
                            <h3>{{ realTimeStats.systemLoad }}</h3>
                            <p>Charge syst√®me</p>
                        </div>
                    </ion-col>
                </ion-row>
            </ion-grid>

            <!-- Utilisateurs actifs -->
            @if (activeUsersList && activeUsersList.length > 0) {
            <div class="active-users-section"
                style="margin: 16px 0; padding: 12px; background: var(--ion-color-light-tint); border-radius: 8px;">
                <h4>üë§ Utilisateurs Actifs ({{ activeUsersList.length }})</h4>
                <ion-list>
                    <ion-item *ngFor="let user of activeUsersList">
                        <ion-avatar slot="start">
                            <img [src]="user.avatar_url || '/assets/profil/base.png'" alt="Avatar"
                                onerror="this.src='/assets/profil/base.png'">
                        </ion-avatar>
                        <ion-label>
                            <h3>{{ user.display_name || user.username || 'Utilisateur' }}</h3>
                            <p>{{ user.email || user.id }}</p>
                        </ion-label>
                        <ion-badge color="success" slot="end">En ligne</ion-badge>
                    </ion-item>
                </ion-list>
            </div>
            }

            <!-- √âv√©nements en temps r√©el -->
            <h4>üìä Flux d'√âv√©nements en Direct</h4>
            <div class="realtime-events">
                <ion-list>
                    <ion-item *ngFor="let event of realTimeEvents | slice:0:15">
                        <ion-icon [name]="getEventIcon(event.category)" [color]="getEventColor(event.level)"
                            slot="start">
                        </ion-icon>
                        <ion-label>
                            <h3>{{ event.message }}</h3>
                            <p><strong>{{ event.category }}</strong> - {{ event.user_name || 'Syst√®me' }}</p>
                            <p><small>{{ formatTimestamp(event.timestamp) }} ({{ getTimeAgo(event.timestamp)
                                    }})</small></p>
                        </ion-label>
                        <ion-chip [color]="event.level === 'error' ? 'danger' : 'primary'" slot="end">
                            {{ event.level }}
                        </ion-chip>
                    </ion-item>
                </ion-list>
            </div>

            <!-- Alertes syst√®me -->
            @if (systemAlerts.length > 0) {
            <div>
                <h4>ÔøΩ Alertes Syst√®me</h4>
                <ion-list>
                    <ion-item *ngFor="let alert of systemAlerts" color="danger">
                        <ion-icon name="warning-outline" slot="start" color="danger"></ion-icon>
                        <ion-label>
                            <h3>{{ alert.message }}</h3>
                            <p>{{ alert.details }}</p>
                        </ion-label>
                    </ion-item>
                </ion-list>
            </div>
            }

            @if (realTimeEvents.length === 0) {
            <div class="no-data">
                <p>Aucun √©v√©nement en temps r√©el</p>
                <ion-button (click)="loadRealTimeData()">Actualiser</ion-button>
            </div>
            }
        </ion-card-content>
    </ion-card>
    }

    <!-- Modal d'analyse d√©taill√©e d'un fail -->
    @if (showFailAnalysisModal && failAnalysisDetails) {
    <div class="modal-backdrop" (click)="closeFailAnalysisModal()">
        <div class="custom-modal" (click)="$event.stopPropagation()">
            <ion-card class="modal-card">
                <ion-card-header>
                    <ion-card-title>
                        <ion-icon name="analytics-outline" color="primary"></ion-icon>
                        Analyse D√©taill√©e du Fail
                    </ion-card-title>
                    <ion-card-subtitle>{{ failAnalysisDetails.title }}</ion-card-subtitle>
                </ion-card-header>

                <ion-card-content>
                    <!-- Informations de base -->
                    <div class="analysis-section">
                        <h4>üìã Informations G√©n√©rales</h4>
                        <ion-list>
                            <ion-item>
                                <ion-icon name="fingerprint-outline" slot="start" color="medium"></ion-icon>
                                <ion-label>
                                    <h3>ID du Fail</h3>
                                    <p class="fail-id">{{ failAnalysisDetails.id }}</p>
                                </ion-label>
                            </ion-item>
                            <ion-item>
                                <ion-icon name="person-outline" slot="start" color="medium"></ion-icon>
                                <ion-label>
                                    <h3>Auteur</h3>
                                    <p>{{ failAnalysisDetails.author?.display_name || 'Inconnu' }}</p>
                                    <p><small>{{ failAnalysisDetails.author?.email || '' }}</small></p>
                                </ion-label>
                            </ion-item>
                            <ion-item>
                                <ion-icon name="calendar-outline" slot="start" color="medium"></ion-icon>
                                <ion-label>
                                    <h3>Date de Cr√©ation</h3>
                                    <p>{{ formatTimestamp(failAnalysisDetails.created_at) }}</p>
                                </ion-label>
                            </ion-item>
                        </ion-list>
                    </div>

                    <!-- Comparaison des compteurs -->
                    <div class="analysis-section">
                        <h4>üî¢ Comparaison D√©taill√©e des Compteurs</h4>

                        <!-- Tableau de comparaison par type -->
                        <ion-list>
                            <ion-list-header>
                                <ion-label><strong>D√©tail par Type de R√©action</strong></ion-label>
                            </ion-list-header>

                            <!-- Courage -->
                            <ion-item>
                                <ion-icon name="heart-outline" color="danger" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Courage</h3>
                                    <div class="reaction-details">
                                        <span class="stored">Stock√©: {{ failAnalysisDetails.storedBreakdown.courage
                                            }}</span>
                                        <span class="actual">R√©el: {{ failAnalysisDetails.reactionBreakdown.courage
                                            }}</span>
                                        <span class="difference"
                                            [class.positive]="failAnalysisDetails.differencesByType.courage > 0"
                                            [class.negative]="failAnalysisDetails.differencesByType.courage < 0">
                                            Diff: {{ failAnalysisDetails.differencesByType.courage > 0 ? '+' : '' }}{{
                                            failAnalysisDetails.differencesByType.courage }}
                                        </span>
                                    </div>
                                    @if (failAnalysisDetails.reactionDetails?.courage?.length > 0) {
                                    <div class="users-who-reacted">
                                        <small>Utilisateurs: {{ getUsersForReactionType('courage') }}</small>
                                    </div>
                                    }
                                </ion-label>
                            </ion-item>

                            <!-- Support -->
                            <ion-item>
                                <ion-icon name="hand-left-outline" color="warning" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Support</h3>
                                    <div class="reaction-details">
                                        <span class="stored">Stock√©: {{ failAnalysisDetails.storedBreakdown.support
                                            }}</span>
                                        <span class="actual">R√©el: {{ failAnalysisDetails.reactionBreakdown.support
                                            }}</span>
                                        <span class="difference"
                                            [class.positive]="failAnalysisDetails.differencesByType.support > 0"
                                            [class.negative]="failAnalysisDetails.differencesByType.support < 0">
                                            Diff: {{ failAnalysisDetails.differencesByType.support > 0 ? '+' : '' }}{{
                                            failAnalysisDetails.differencesByType.support }}
                                        </span>
                                    </div>
                                    @if (failAnalysisDetails.reactionDetails?.support?.length > 0) {
                                    <div class="users-who-reacted">
                                        <small>Utilisateurs: {{ getUsersForReactionType('support') }}</small>
                                    </div>
                                    }
                                </ion-label>
                            </ion-item>

                            <!-- Empathie -->
                            <ion-item>
                                <ion-icon name="sad-outline" color="secondary" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Empathie</h3>
                                    <div class="reaction-details">
                                        <span class="stored">Stock√©: {{ failAnalysisDetails.storedBreakdown.empathy
                                            }}</span>
                                        <span class="actual">R√©el: {{ failAnalysisDetails.reactionBreakdown.empathy
                                            }}</span>
                                        <span class="difference"
                                            [class.positive]="failAnalysisDetails.differencesByType.empathy > 0"
                                            [class.negative]="failAnalysisDetails.differencesByType.empathy < 0">
                                            Diff: {{ failAnalysisDetails.differencesByType.empathy > 0 ? '+' : '' }}{{
                                            failAnalysisDetails.differencesByType.empathy }}
                                        </span>
                                    </div>
                                    @if (failAnalysisDetails.reactionDetails?.empathy?.length > 0) {
                                    <div class="users-who-reacted">
                                        <small>Utilisateurs: {{ getUsersForReactionType('empathy') }}</small>
                                    </div>
                                    }
                                </ion-label>
                            </ion-item>

                            <!-- Rire -->
                            <ion-item>
                                <ion-icon name="happy-outline" color="tertiary" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Rire</h3>
                                    <div class="reaction-details">
                                        <span class="stored">Stock√©: {{ failAnalysisDetails.storedBreakdown.laugh
                                            }}</span>
                                        <span class="actual">R√©el: {{ failAnalysisDetails.reactionBreakdown.laugh
                                            }}</span>
                                        <span class="difference"
                                            [class.positive]="failAnalysisDetails.differencesByType.laugh > 0"
                                            [class.negative]="failAnalysisDetails.differencesByType.laugh < 0">
                                            Diff: {{ failAnalysisDetails.differencesByType.laugh > 0 ? '+' : '' }}{{
                                            failAnalysisDetails.differencesByType.laugh }}
                                        </span>
                                    </div>
                                    @if (failAnalysisDetails.reactionDetails?.laugh?.length > 0) {
                                    <div class="users-who-reacted">
                                        <small>Utilisateurs: {{ getUsersForReactionType('laugh') }}</small>
                                    </div>
                                    }
                                </ion-label>
                            </ion-item>
                        </ion-list>

                        <!-- R√©sum√© global -->
                        <div class="global-summary">
                            <ion-grid>
                                <ion-row>
                                    <ion-col>
                                        <div class="summary-card stored">
                                            <strong>Total Stock√©</strong>
                                            <span>{{ failAnalysisDetails.storedReactions }}</span>
                                        </div>
                                    </ion-col>
                                    <ion-col>
                                        <div class="summary-card actual">
                                            <strong>Total R√©el</strong>
                                            <span>{{ failAnalysisDetails.actualReactions }}</span>
                                        </div>
                                    </ion-col>
                                    <ion-col>
                                        <div class="summary-card difference"
                                            [class.positive]="failAnalysisDetails.difference > 0"
                                            [class.negative]="failAnalysisDetails.difference < 0">
                                            <strong>Diff√©rence</strong>
                                            <span>{{ failAnalysisDetails.difference > 0 ? '+' : '' }}{{
                                                failAnalysisDetails.difference }}</span>
                                        </div>
                                    </ion-col>
                                </ion-row>
                            </ion-grid>
                        </div>
                    </div>

                    <!-- Message d'alerte si n√©cessaire -->
                    @if (failAnalysisDetails.actualReactions === 0 && failAnalysisDetails.storedReactions > 0) {
                    <div class="alert-section">
                        <ion-chip color="warning">
                            <ion-icon name="warning-outline"></ion-icon>
                            <ion-label>‚ö†Ô∏è Toutes les r√©actions ont √©t√© supprim√©es de ce fail</ion-label>
                        </ion-chip>
                    </div>
                    }

                    <!-- Actions -->
                    <div class="modal-actions">
                        <ion-button expand="block" fill="outline" (click)="closeFailAnalysisModal()">
                            <ion-icon name="close-outline" slot="start"></ion-icon>
                            Fermer
                        </ion-button>
                        @if (failAnalysisDetails.isProblematic) {
                        <ion-button expand="block" (click)="fixFromAnalysisModal()" [disabled]="loading"
                            color="success">
                            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                            Corriger Automatiquement
                        </ion-button>
                        }
                    </div>
                </ion-card-content>
            </ion-card>
        </div>
    </div>
    }

    <!-- DATABASE MANAGEMENT SECTION -->
    @if (selectedSegment === 'database') {
    <ion-card>
        <ion-card-header>
            <ion-card-title>üóëÔ∏è Gestion de la Base de Donn√©es</ion-card-title>
            <ion-card-subtitle>‚ö†Ô∏è Zone de danger - Actions irr√©versibles</ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
            <div class="warning-banner">
                <ion-chip color="danger">
                    <ion-icon name="warning-outline"></ion-icon>
                    <ion-label>ATTENTION : Ces actions vident compl√®tement les tables s√©lectionn√©es !</ion-label>
                </ion-chip>
            </div>

            <!-- Tables du domaine public -->
            <div class="table-section">
                <h3>üìä Tables de l'Application FailDaily</h3>
                <ion-grid>
                    <!-- Ligne 1: Core Tables -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('fails')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="document-text-outline" slot="start"></ion-icon>
                                Vider "fails" (Posts)
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('reactions')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="heart-outline" slot="start"></ion-icon>
                                Vider "reactions"
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 2: User Data -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('profiles')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="person-outline" slot="start"></ion-icon>
                                Vider "profiles"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('user_preferences')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="settings-outline" slot="start"></ion-icon>
                                Vider "user_preferences"
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 3: Comments & Interactions -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('comments')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
                                Vider "comments"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('badges')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="medal-outline" slot="start"></ion-icon>
                                Vider "badges" (historique)
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 4: Badge System -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('user_badges')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="ribbon-outline" slot="start"></ion-icon>
                                Vider "user_badges"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="manageBadgeDefinitions()" [disabled]="loading"
                                color="secondary" fill="outline">
                                <ion-icon name="construct-outline" slot="start"></ion-icon>
                                G√©rer "badge_definitions"
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 5: Logs & Activities -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('system_logs')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="terminal-outline" slot="start"></ion-icon>
                                Vider "system_logs"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('activity_logs')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="list-outline" slot="start"></ion-icon>
                                Vider "activity_logs"
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 6: Detailed Logs -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('reaction_logs')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="analytics-outline" slot="start"></ion-icon>
                                Vider "reaction_logs"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('user_activities')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="pulse-outline" slot="start"></ion-icon>
                                Vider "user_activities"
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Ligne 7: Management & Config -->
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('user_management_logs')"
                                [disabled]="loading" color="warning" fill="outline">
                                <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
                                Vider "user_management_logs"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('app_config')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="cog-outline" slot="start"></ion-icon>
                                Vider "app_config"
                            </ion-button>
                        </ion-col>
                    </ion-row>
                </ion-grid>
            </div>

            <!-- Tables realtime -->
            <div class="table-section">
                <h3>‚ö° Tables Temps R√©el</h3>
                <ion-grid>
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('realtime.messages')" [disabled]="loading"
                                color="warning" fill="outline">
                                <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
                                Vider "messages"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('realtime.subscription')"
                                [disabled]="loading" color="warning" fill="outline">
                                <ion-icon name="radio-outline" slot="start"></ion-icon>
                                Vider "subscription"
                            </ion-button>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <ion-col size="12">
                            <ion-button expand="block" (click)="truncateRealtimePartitions()" [disabled]="loading"
                                color="warning">
                                <ion-icon name="layers-outline" slot="start"></ion-icon>
                                Vider TOUTES les partitions messages (2025_08_xx)
                            </ion-button>
                        </ion-col>
                    </ion-row>
                </ion-grid>
            </div>

            <!-- Tables storage -->
            <div class="table-section">
                <h3>üìÅ Tables Stockage</h3>
                <div class="auth-warning">
                    <ion-chip color="danger">
                        <ion-icon name="warning-outline"></ion-icon>
                        <ion-label>Cela supprimera tous les fichiers upload√©s !</ion-label>
                    </ion-chip>
                </div>
                <ion-grid>
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('storage.objects')" [disabled]="loading"
                                color="danger" fill="outline">
                                <ion-icon name="folder-outline" slot="start"></ion-icon>
                                Vider "storage.objects"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateTable('storage.buckets')" [disabled]="loading"
                                color="danger" fill="outline">
                                <ion-icon name="archive-outline" slot="start"></ion-icon>
                                Vider "storage.buckets"
                            </ion-button>
                        </ion-col>
                    </ion-row>
                </ion-grid>
            </div>

            <!-- Tables d'authentification -->
            <div class="table-section">
                <h3>üîê Tables d'Authentification</h3>
                <div class="auth-warning">
                    <ion-chip color="danger">
                        <ion-icon name="shield-outline"></ion-icon>
                        <ion-label>Ces actions suppriment tous les utilisateurs !</ion-label>
                    </ion-chip>
                </div>
                <ion-grid>
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="deleteAllUsers()" [disabled]="loading" color="danger"
                                fill="solid">
                                <ion-icon name="people-outline" slot="start"></ion-icon>
                                Supprimer TOUS les utilisateurs
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateAuthTable('auth.identities')"
                                [disabled]="loading" color="danger" fill="outline">
                                <ion-icon name="key-outline" slot="start"></ion-icon>
                                Vider "auth.identities"
                            </ion-button>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateAuthTable('auth.sessions')" [disabled]="loading"
                                color="danger" fill="outline">
                                <ion-icon name="time-outline" slot="start"></ion-icon>
                                Vider "auth.sessions"
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateAuthTable('auth.refresh_tokens')"
                                [disabled]="loading" color="danger" fill="outline">
                                <ion-icon name="refresh-circle-outline" slot="start"></ion-icon>
                                Vider "auth.refresh_tokens"
                            </ion-button>
                        </ion-col>
                    </ion-row>
                </ion-grid>
            </div>

            <!-- Actions group√©es -->
            <div class="table-section">
                <h3>üí• Actions Group√©es</h3>
                <ion-grid>
                    <ion-row>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateAllAppTables()" [disabled]="loading"
                                color="warning">
                                <ion-icon name="nuclear-outline" slot="start"></ion-icon>
                                Vider TOUTES les tables app
                            </ion-button>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <ion-button expand="block" (click)="truncateAllAuthTables()" [disabled]="loading"
                                color="danger">
                                <ion-icon name="skull-outline" slot="start"></ion-icon>
                                Vider TOUTES les tables auth
                            </ion-button>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <ion-col size="12">
                            <ion-button expand="block" (click)="truncateEverything()" [disabled]="loading"
                                color="danger" fill="solid">
                                <ion-icon name="trash-bin-outline" slot="start"></ion-icon>
                                üíÄ RESET COMPLET DE LA BASE
                            </ion-button>
                        </ion-col>
                    </ion-row>

                    <!-- Bouton de restauration d'urgence -->
                    <ion-row>
                        <ion-col size="12">
                            <ion-button expand="block" (click)="emergencyRestoreConfigurations()" [disabled]="loading"
                                color="tertiary" fill="outline">
                                <ion-icon name="construct-outline" slot="start"></ion-icon>
                                üö® RESTAURATION D'URGENCE (Config App)
                            </ion-button>
                            <ion-note>
                                <small>Utilisez ce bouton si l'application ne fonctionne plus apr√®s un reset</small>
                            </ion-note>
                        </ion-col>
                    </ion-row>
                </ion-grid>
            </div>

            <!-- Statut des op√©rations -->
            @if (truncateResults.length > 0) {
            <div class="results-section">
                <h3>üìã R√©sultats des Op√©rations</h3>
                @for (result of truncateResults; track result.table) {
                <ion-chip [color]="result.success ? 'success' : 'danger'">
                    <ion-icon [name]="result.success ? 'checkmark-circle-outline' : 'close-circle-outline'"></ion-icon>
                    <ion-label>{{ result.table }}: {{ result.message }}</ion-label>
                </ion-chip>
                }
            </div>
            }
        </ion-card-content>
    </ion-card>
    }

    <!-- ====== MODAL DE GESTION DES BADGE DEFINITIONS ====== -->
    @if (showBadgeManagementModal) {
    <div class="modal-backdrop">
        <div class="modal-container">
            <ion-card class="management-modal">
                <ion-card-header>
                    <ion-card-title>üèÜ Gestion des D√©finitions de Badges</ion-card-title>
                    <ion-card-subtitle>Ajouter, voir et supprimer les badges en double</ion-card-subtitle>
                </ion-card-header>

                <ion-card-content>
                    <!-- R√©sum√© des badges -->
                    <div class="summary-section">
                        <ion-chip color="primary">
                            <ion-icon name="medal-outline"></ion-icon>
                            <ion-label>Total: {{ badgeDefinitions.length }} badges</ion-label>
                        </ion-chip>
                        @if (duplicateBadges.length > 0) {
                        <ion-chip color="warning">
                            <ion-icon name="warning-outline"></ion-icon>
                            <ion-label>{{ duplicateBadges.length }} doublons d√©tect√©s</ion-label>
                        </ion-chip>
                        }
                    </div>

                    <!-- Actions principales -->
                    <div class="badge-actions">
                        <ion-button expand="block" (click)="loadBadgeDefinitions()" [disabled]="loading" fill="outline">
                            <ion-icon name="refresh-outline" slot="start"></ion-icon>
                            Actualiser la liste
                        </ion-button>
                        @if (duplicateBadges.length > 0) {
                        <ion-button expand="block" (click)="removeDuplicateBadges()" [disabled]="loading"
                            color="warning">
                            <ion-icon name="trash-outline" slot="start"></ion-icon>
                            Supprimer tous les doublons ({{ duplicateBadges.length }})
                        </ion-button>
                        }
                    </div>

                    <!-- Liste des badges -->
                    <div class="badge-list">
                        <h4>üìã Liste des badges :</h4>
                        @if (badgeDefinitions.length === 0) {
                        <div class="empty-state">
                            <ion-icon name="medal-outline" size="large"></ion-icon>
                            <p>Aucun badge trouv√©</p>
                        </div>
                        } @else {
                        @for (badge of badgeDefinitions; track badge.id) {
                        <div class="badge-item" [class.duplicate]="isDuplicateBadge(badge)">
                            <div class="badge-info">
                                <ion-icon [name]="badge.icon" [color]="getBadgeRarityColor(badge.rarity)"></ion-icon>
                                <div class="badge-details">
                                    <h5>{{ badge.name }}</h5>
                                    <p class="badge-meta">
                                        {{ badge.category }} ‚Ä¢ {{ badge.rarity }} ‚Ä¢
                                        {{ badge.requirement_type }}: {{ badge.requirement_value }}
                                    </p>
                                    <p class="badge-description">{{ badge.description }}</p>
                                </div>
                            </div>
                            <div class="badge-actions-mini">
                                @if (isDuplicateBadge(badge)) {
                                <ion-chip color="warning">
                                    <ion-icon name="copy-outline"></ion-icon>
                                    <ion-label>Doublon</ion-label>
                                </ion-chip>
                                <ion-button (click)="deleteBadgeDefinition(badge.id)" size="small" color="danger"
                                    fill="clear">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </ion-button>
                                } @else {
                                <ion-chip color="success">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                    <ion-label>Unique</ion-label>
                                </ion-chip>
                                }
                            </div>
                        </div>
                        }
                        }
                    </div>

                    <!-- Formulaire d'ajout -->
                    <div class="add-badge-section">
                        <h4>‚ûï Ajouter un nouveau badge :</h4>
                        <div class="form-grid">
                            <ion-item>
                                <ion-label position="stacked">Nom du badge</ion-label>
                                <ion-input [(ngModel)]="newBadge.name" placeholder="Ex: Ma√Ætre du Courage"></ion-input>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Description</ion-label>
                                <ion-textarea [(ngModel)]="newBadge.description"
                                    placeholder="Description du badge..."></ion-textarea>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Ic√¥ne</ion-label>
                                <ion-select [(ngModel)]="newBadge.icon" placeholder="Choisir une ic√¥ne">
                                    <ion-select-option value="trophy-outline">üèÜ Troph√©e</ion-select-option>
                                    <ion-select-option value="medal-outline">ü•á M√©daille</ion-select-option>
                                    <ion-select-option value="star-outline">‚≠ê √âtoile</ion-select-option>
                                    <ion-select-option value="shield-outline">üõ°Ô∏è Bouclier</ion-select-option>
                                    <ion-select-option value="heart-outline">‚ù§Ô∏è C≈ìur</ion-select-option>
                                    <ion-select-option value="flame-outline">üî• Flamme</ion-select-option>
                                    <ion-select-option value="diamond-outline">üíé Diamant</ion-select-option>
                                    <ion-select-option value="ribbon-outline">üéóÔ∏è Ruban</ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Cat√©gorie</ion-label>
                                <ion-select [(ngModel)]="newBadge.category" placeholder="Choisir une cat√©gorie">
                                    <ion-select-option value="COURAGE">Courage</ion-select-option>
                                    <ion-select-option value="ENTRAIDE">Entraide</ion-select-option>
                                    <ion-select-option value="PERSEVERANCE">Pers√©v√©rance</ion-select-option>
                                    <ion-select-option value="HUMOUR">Humour</ion-select-option>
                                    <ion-select-option value="RESILIENCE">R√©silience</ion-select-option>
                                    <ion-select-option value="SPECIAL">Sp√©cial</ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Raret√©</ion-label>
                                <ion-select [(ngModel)]="newBadge.rarity" placeholder="Choisir la raret√©">
                                    <ion-select-option value="common">Commun</ion-select-option>
                                    <ion-select-option value="rare">Rare</ion-select-option>
                                    <ion-select-option value="epic">√âpique</ion-select-option>
                                    <ion-select-option value="legendary">L√©gendaire</ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Type de condition</ion-label>
                                <ion-select [(ngModel)]="newBadge.requirement_type" placeholder="Type de condition">
                                    <ion-select-option value="fail_count">Nombre de fails</ion-select-option>
                                    <ion-select-option value="streak_days">Jours cons√©cutifs</ion-select-option>
                                    <ion-select-option value="reaction_given">R√©actions donn√©es</ion-select-option>
                                    <ion-select-option value="reactions_received">R√©actions re√ßues</ion-select-option>
                                    <ion-select-option value="total_laughs">Total rires</ion-select-option>
                                    <ion-select-option value="help_count">Aides donn√©es</ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">Valeur requise</ion-label>
                                <ion-input type="number" [(ngModel)]="newBadge.requirement_value"
                                    placeholder="Ex: 10"></ion-input>
                            </ion-item>
                        </div>
                        <ion-button expand="block" (click)="addBadgeDefinition()"
                            [disabled]="loading || !isNewBadgeValid()" color="success">
                            <ion-icon name="add-outline" slot="start"></ion-icon>
                            Ajouter le badge
                        </ion-button>
                    </div>

                    <!-- Actions du modal -->
                    <div class="modal-actions">
                        <ion-button expand="block" fill="outline" (click)="closeBadgeManagementModal()">
                            <ion-icon name="close-outline" slot="start"></ion-icon>
                            Fermer
                        </ion-button>
                    </div>
                </ion-card-content>
            </ion-card>
        </div>
    </div>
    }

    <!-- MODAL D√âTAILS LOG -->
    @if (selectedLogForDetails) {
    <ion-modal [isOpen]="!!selectedLogForDetails" (didDismiss)="closeLogDetails()">
        <ng-template>
            <ion-header>
                <ion-toolbar color="primary">
                    <ion-title>
                        <ion-icon [name]="getLogActivityIcon(selectedLogForDetails.activity_type)" 
                                 [color]="getLogLevelColor(selectedLogForDetails.level)"></ion-icon>
                        D√©tails du Log
                    </ion-title>
                    <ion-buttons slot="end">
                        <ion-button (click)="closeLogDetails()">
                            <ion-icon name="close"></ion-icon>
                        </ion-button>
                    </ion-buttons>
                </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding">
                <ion-card>
                    <ion-card-header>
                        <ion-card-title>
                            {{ selectedLogForDetails.activity_type | titlecase }}
                            <ion-badge [color]="getLogLevelColor(selectedLogForDetails.level)" slot="end">
                                {{ selectedLogForDetails.level }}
                            </ion-badge>
                        </ion-card-title>
                        <ion-card-subtitle>
                            {{ selectedLogForDetails.description }}
                        </ion-card-subtitle>
                    </ion-card-header>
                    <ion-card-content>
                        <ion-list>
                            <ion-item>
                                <ion-icon name="person-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Utilisateur</h3>
                                    <p>{{ selectedLogForDetails.user_email || 'Syst√®me' }}</p>
                                    @if (selectedLogForDetails.user_id) {
                                    <p><small>ID: {{ selectedLogForDetails.user_id }}</small></p>
                                    }
                                </ion-label>
                            </ion-item>
                            
                            <ion-item>
                                <ion-icon name="time-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Timestamp</h3>
                                    <p>{{ selectedLogForDetails.created_at | date:'dd/MM/yyyy HH:mm:ss' }}</p>
                                    <p><small>{{ getTimeAgo(selectedLogForDetails.created_at) }}</small></p>
                                </ion-label>
                            </ion-item>
                            
                            <ion-item>
                                <ion-icon name="globe-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Adresse IP</h3>
                                    <p>{{ selectedLogForDetails.ip_address || 'Non disponible' }}</p>
                                </ion-label>
                            </ion-item>
                            
                            @if (selectedLogForDetails.user_agent) {
                            <ion-item>
                                <ion-icon name="phone-portrait-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>User Agent</h3>
                                    <p style="word-break: break-all; font-size: 0.8em;">
                                        {{ selectedLogForDetails.user_agent }}
                                    </p>
                                </ion-label>
                            </ion-item>
                            }
                            
                            @if (selectedLogForDetails.duration_ms) {
                            <ion-item>
                                <ion-icon name="speedometer-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>Temps d'ex√©cution</h3>
                                    <p>{{ selectedLogForDetails.duration_ms }} millisecondes</p>
                                </ion-label>
                            </ion-item>
                            }
                            
                            @if (selectedLogForDetails.metadata) {
                            <ion-item>
                                <ion-icon name="document-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h3>M√©tadonn√©es</h3>
                                    <pre style="font-size: 0.8em; background: var(--ion-color-light); padding: 8px; border-radius: 4px; overflow-x: auto;">{{ formatMetadata(selectedLogForDetails.metadata) }}</pre>
                                </ion-label>
                            </ion-item>
                            }
                        </ion-list>
                        
                        <ion-button expand="block" color="tertiary" (click)="viewUserLogs(selectedLogForDetails.user_id)"
                                   [disabled]="!selectedLogForDetails.user_id">
                            <ion-icon name="person-outline" slot="start"></ion-icon>
                            Voir l'historique complet de cet utilisateur
                        </ion-button>
                    </ion-card-content>
                </ion-card>
            </ion-content>
        </ng-template>
    </ion-modal>
    }
</ion-content>
