<ion-header>
  <ion-toolbar>
    <ion-title>üõ°Ô∏è Espace Mod√©ration</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChange($event)">
    <ion-segment-button value="fails_mod">
      <ion-label>Fails √† mod√©rer</ion-label>
    </ion-segment-button>
    <ion-segment-button value="comments_mod">
      <ion-label>Commentaires √† mod√©rer</ion-label>
    </ion-segment-button>
    <ion-segment-button value="validated">
      <ion-label>Valid√©s</ion-label>
    </ion-segment-button>
    <ion-segment-button value="hidden">
      <ion-label>Masqu√©s</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Fails moderation tools (quick delete) -->
  <div *ngIf="selectedSegment === 'fails_mod'" class="section">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Supprimer un fail</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">ID du fail</ion-label>
          <ion-input [(ngModel)]="failId" placeholder="ex: 123"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Raison</ion-label>
          <ion-textarea [(ngModel)]="failDeleteReason" rows="3" placeholder="ex: contenu inappropri√©"></ion-textarea>
        </ion-item>
        <ion-button expand="block" color="danger" (click)="deleteFail()" [disabled]="deleting">
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          Supprimer le fail
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Users (optional) -->
  <div *ngIf="false" class="section">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Rechercher un utilisateur</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Email / Pseudo / ID</ion-label>
          <ion-input [(ngModel)]="searchQuery" (keyup.enter)="searchUsers()" placeholder="ex: alice@‚Ä¶"></ion-input>
        </ion-item>
        <ion-button expand="block" (click)="searchUsers()" [disabled]="loadingUsers">
          <ion-icon name="search-outline" slot="start"></ion-icon>
          Rechercher
        </ion-button>

        <ion-list *ngIf="users.length">
          <ion-list-header>R√©sultats</ion-list-header>
          <ion-item *ngFor="let u of users" (click)="pickUser(u)">
            <ion-label>
              <h3>{{ u.display_name || u.username || 'Utilisateur' }} <small>#{{ u.id }}</small></h3>
              <p>{{ u.email }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="selectedUser">
      <ion-card-header>
        <ion-card-title>Modifier le pseudo</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Nouveau pseudo</ion-label>
          <ion-input [(ngModel)]="newDisplayName" placeholder="Nouveau pseudo"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Raison</ion-label>
          <ion-textarea [(ngModel)]="updateReason" rows="2" placeholder="Motif de la modification"></ion-textarea>
        </ion-item>
        <ion-button expand="block" color="primary" (click)="updateDisplayName()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Enregistrer
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Reported Fails -->
  <div class="section" *ngIf="selectedSegment === 'fails_mod'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Fails signal√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let f of reportedFails">
            <ion-label>
              <h3>{{ f.title }} <small>#{{ f.fail_id }}</small></h3>
              <p>Par: {{ f.display_name }} ‚Äî {{ f.category }} ‚Äî Signalements: {{ f.reports }}</p>
              <p>Statut: {{ f.moderation_status || 'approved' }}</p>
            </ion-label>
            <ion-button size="small" color="success" (click)="approveFail(f.fail_id)">Approuver</ion-button>
            <ion-button size="small" color="warning" (click)="hideFail(f.fail_id)">Masquer</ion-button>
          </ion-item>
          <ion-item *ngIf="!reportedFails.length">
            <ion-label>Aucun fail √† mod√©rer</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

  </div>

  <!-- Reported Comments -->
  <div class="section" *ngIf="selectedSegment === 'comments_mod'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Commentaires signal√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let c of reportedComments">
            <ion-label>
              <h3>Commentaire #{{ c.comment_id || c.comment?.id }} ‚Äî Signalements: {{ c.reports }}</h3>
              <p>{{ c.content || c.comment?.content }}</p>
              <p>Fail: {{ c.fail_id || c.comment?.fail_id }} ‚Äî Auteur: {{ c.user_id || c.comment?.user_id }}</p>
            </ion-label>
            <ion-button size="small" color="success" (click)="approveComment(c.comment_id || c.comment?.id)">Approuver</ion-button>
            <ion-button size="small" color="warning" (click)="hideComment(c.comment_id || c.comment?.id)">Masquer</ion-button>
          </ion-item>
          <ion-item *ngIf="!reportedComments.length">
            <ion-label>Aucun commentaire √† mod√©rer</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Validated lists -->
  <div class="section" *ngIf="selectedSegment === 'validated'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Fails valid√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let f of approvedFails">
            <ion-label>
              <h3>{{ f.title }} <small>#{{ f.fail_id }}</small></h3>
              <p>Par: {{ f.display_name }} ‚Äî {{ f.category }}</p>
            </ion-label>
            <ion-button size="small" color="warning" (click)="hideFail(f.fail_id)">Masquer</ion-button>
          </ion-item>
          <ion-item *ngIf="!approvedFails.length">
            <ion-label>Aucun fail valid√©</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Commentaires valid√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let c of approvedComments">
            <ion-label>
              <h3>Commentaire #{{ c.comment_id }}</h3>
              <p>{{ c.content }}</p>
              <p>Fail: {{ c.fail_id }} ‚Äî Auteur: {{ c.display_name }}</p>
            </ion-label>
            <ion-button size="small" color="warning" (click)="hideComment(c.comment_id)">Masquer</ion-button>
          </ion-item>
          <ion-item *ngIf="!approvedComments.length">
            <ion-label>Aucun commentaire valid√©</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Hidden lists -->
  <div class="section" *ngIf="selectedSegment === 'hidden'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Fails masqu√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let f of hiddenFails">
            <ion-label>
              <h3>{{ f.title }} <small>#{{ f.fail_id }}</small></h3>
              <p>Par: {{ f.display_name }} ‚Äî {{ f.category }}</p>
            </ion-label>
            <ion-button size="small" color="success" (click)="approveFail(f.fail_id)">Approuver</ion-button>
          </ion-item>
          <ion-item *ngIf="!hiddenFails.length">
            <ion-label>Aucun fail masqu√©</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Commentaires masqu√©s</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let c of hiddenComments">
            <ion-label>
              <h3>Commentaire #{{ c.comment_id }}</h3>
              <p>{{ c.content }}</p>
              <p>Fail: {{ c.fail_id }} ‚Äî Auteur: {{ c.display_name }}</p>
            </ion-label>
            <ion-button size="small" color="success" (click)="approveComment(c.comment_id)">Approuver</ion-button>
          </ion-item>
          <ion-item *ngIf="!hiddenComments.length">
            <ion-label>Aucun commentaire masqu√©</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
  <ion-card>
    <ion-card-header>
      <ion-card-title>Configuration de Mod√©ration</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label position="stacked">Seuil signalements Fails</ion-label>
        <ion-input type="number" [(ngModel)]="failThreshold"></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Seuil signalements Commentaires</ion-label>
        <ion-input type="number" [(ngModel)]="commentThreshold"></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Intervalle d'auto-refresh (secondes)</ion-label>
        <ion-input type="number" [(ngModel)]="refreshIntervalSec" min="5"></ion-input>
      </ion-item>
      <ion-button expand="block" (click)="saveThresholds()">Enregistrer</ion-button>
    </ion-card-content>

  </ion-card>
</ion-content>
